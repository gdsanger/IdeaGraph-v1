{% load static %}
<!-- Chat Sidebar (Right) -->
<aside class="chat-sidebar bg-dark border-start border-secondary" 
       id="chatSidebar" 
       data-object-type="{{ object_type }}" 
       data-object-id="{{ object_id }}">
    <!-- Resize handle -->
    <div class="chat-sidebar-resize-handle" id="chatSidebarResizeHandle" title="Breite anpassen"></div>
    <div class="chat-sidebar-header p-3 border-bottom border-secondary d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
            <i class="bi bi-chat-dots"></i> Q&A Assistant
        </h6>
        <button class="btn btn-sm btn-link text-white p-0" 
                onclick="toggleChatSidebar()"
                title="Schließen">
            <i class="bi bi-x-lg"></i>
        </button>
    </div>
    <div class="chat-sidebar-body p-3">
        <!-- Chat Widget Container -->
        <div id="ideagraph-chat-widget-sidebar"></div>
    </div>
</aside>

<style>
    /* Chat Sidebar Styles */
    :root {
        --chat-sidebar-default-width: 650px;
    }
    
    .chat-sidebar {
        position: fixed;
        top: 0;
        right: 0;
        width: var(--chat-sidebar-default-width);  /* Use CSS custom property */
        height: 100vh;
        z-index: 1040;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
    }
    
    .chat-sidebar.show {
        transform: translateX(0);
    }
    
    /* Main content adjustment when sidebar is open */
    body.chat-sidebar-open main,
    body.chat-sidebar-open .container,
    body.chat-sidebar-open .container-fluid {
        margin-right: var(--chat-sidebar-width, var(--chat-sidebar-default-width));  /* Use dynamic width, fallback to default */
        transition: margin-right 0.3s ease-in-out;
    }
    
    .chat-sidebar-header {
        flex-shrink: 0;
    }
    
    /* Resize handle */
    .chat-sidebar-resize-handle {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 6px;
        cursor: ew-resize;
        background: rgba(229, 154, 40, 0.1);
        transition: background 0.2s ease;
        z-index: 10;
    }
    
    .chat-sidebar-resize-handle:hover {
        background: rgba(229, 154, 40, 0.3);
    }
    
    .chat-sidebar-resize-handle:active {
        background: rgba(229, 154, 40, 0.5);
    }
    
    .chat-sidebar-body {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    #ideagraph-chat-widget-sidebar {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }
    
    /* Smaller font size for sources */
    .message-sources {
        font-size: 0.8rem;
    }
    
    .sources-header {
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .source-item {
        font-size: 0.75rem;
    }
    
    .source-title {
        font-size: 0.8rem;
    }
    
    .source-description {
        font-size: 0.7rem;
    }
    
    /* Thinking indicator animation */
    .thinking-animation {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
    }
    
    .thinking-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--secondary-cyan);
        animation: thinkingPulse 1.4s infinite ease-in-out;
    }
    
    .thinking-dot:nth-child(1) {
        animation-delay: 0s;
    }
    
    .thinking-dot:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .thinking-dot:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    .thinking-text {
        font-style: italic;
        color: var(--secondary-cyan);
        margin-left: 0.25rem;
    }
    
    @keyframes thinkingPulse {
        0%, 60%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        30% {
            transform: scale(1.2);
            opacity: 1;
        }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .chat-sidebar {
            width: 100%;
        }
        
        /* On mobile, don't push content - use overlay instead */
        body.chat-sidebar-open main,
        body.chat-sidebar-open .container,
        body.chat-sidebar-open .container-fluid {
            margin-right: 0;
        }
    }
</style>

<script>
// Chat Sidebar Toggle Functionality
let chatWidgetInstance = null;
let isChatSidebarOpen = false;

function toggleChatSidebar() {
    const sidebar = document.getElementById('chatSidebar');
    const floatingBtn = document.getElementById('chatFloatingBtn');
    
    if (!sidebar) return;
    
    isChatSidebarOpen = !isChatSidebarOpen;
    
    if (isChatSidebarOpen) {
        // Show sidebar and push main content
        sidebar.classList.add('show');
        document.body.classList.add('chat-sidebar-open');
        if (floatingBtn) floatingBtn.classList.add('hidden');
        
        // Apply saved width and set CSS custom property
        const savedWidth = parseInt(localStorage.getItem('chatSidebarWidth') || '650', 10);
        document.documentElement.style.setProperty('--chat-sidebar-width', `${savedWidth}px`);
        
        // Initialize chat widget if not already initialized
        if (!chatWidgetInstance) {
            try {
                const objectType = sidebar.dataset.objectType || 'item';
                const objectId = sidebar.dataset.objectId;
                
                if (!objectId || objectId.trim() === '' || objectId === 'None') {
                    console.warn('ChatWidget: Cannot initialize without object_id');
                    document.getElementById('ideagraph-chat-widget-sidebar').innerHTML = `
                        <div class="alert alert-warning" role="alert">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Keine Kontext-ID verfügbar</strong>
                            <p class="mb-0 mt-2">Der Q&A Chat ist nur auf Item- und Task-Detail-Seiten verfügbar.</p>
                        </div>
                    `;
                    return;
                }
                
                chatWidgetInstance = new ChatWidget({
                    containerId: 'ideagraph-chat-widget-sidebar',
                    itemId: objectId,
                    contextType: objectType === 'item' ? 'Item' : 'Task',
                    apiBaseUrl: `/api/${objectType}s`,
                    theme: 'dark',
                    height: '100%',
                    showHistory: true
                });
                console.log('Chat widget initialized in sidebar');
            } catch (error) {
                console.error('Error initializing chat widget in sidebar:', error);
                document.getElementById('ideagraph-chat-widget-sidebar').innerHTML = `
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Fehler beim Initialisieren des Chats</strong>
                        <p class="mb-0 mt-2">${error.message || 'Ein unbekannter Fehler ist aufgetreten.'}</p>
                    </div>
                `;
            }
        }
    } else {
        // Hide sidebar and restore main content
        sidebar.classList.remove('show');
        document.body.classList.remove('chat-sidebar-open');
        if (floatingBtn) floatingBtn.classList.remove('hidden');
        
        // Clear CSS custom property when sidebar is closed
        document.documentElement.style.removeProperty('--chat-sidebar-width');
    }
}

// Close sidebar on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && isChatSidebarOpen) {
        toggleChatSidebar();
    }
});

// Chat Sidebar Resize Functionality
(function() {
    const STORAGE_KEY = 'chatSidebarWidth';
    const MIN_WIDTH = 400;  // Minimum sidebar width in pixels
    const MAX_WIDTH = 1200; // Maximum sidebar width in pixels
    const DEFAULT_WIDTH = 650; // Default width in pixels
    
    let isResizing = false;
    let currentWidth = DEFAULT_WIDTH;
    
    // Load saved width from localStorage
    function loadSavedWidth() {
        try {
            const savedWidth = localStorage.getItem(STORAGE_KEY);
            if (savedWidth) {
                const width = parseInt(savedWidth, 10);
                if (width >= MIN_WIDTH && width <= MAX_WIDTH) {
                    return width;
                }
            }
        } catch (e) {
            console.warn('Failed to load saved sidebar width:', e);
        }
        return DEFAULT_WIDTH;
    }
    
    // Save width to localStorage
    function saveWidth(width) {
        try {
            localStorage.setItem(STORAGE_KEY, width.toString());
        } catch (e) {
            console.warn('Failed to save sidebar width:', e);
        }
    }
    
    // Apply width to sidebar and adjust content margin
    function applyWidth(width, updateCSS = true) {
        const sidebar = document.getElementById('chatSidebar');
        if (!sidebar) return;
        
        // Clamp width to min/max bounds
        width = Math.max(MIN_WIDTH, Math.min(MAX_WIDTH, width));
        currentWidth = width;
        
        // Apply to sidebar
        sidebar.style.width = `${width}px`;
        
        // Update or clear main content margin using CSS custom property
        if (updateCSS) {
            if (document.body.classList.contains('chat-sidebar-open')) {
                document.documentElement.style.setProperty('--chat-sidebar-width', `${width}px`);
            } else {
                // Clear custom property when sidebar is closed
                document.documentElement.style.removeProperty('--chat-sidebar-width');
            }
        }
    }
    
    // Initialize resize functionality
    function initResize() {
        const resizeHandle = document.getElementById('chatSidebarResizeHandle');
        const sidebar = document.getElementById('chatSidebar');
        
        if (!resizeHandle || !sidebar) return;
        
        // Load and apply saved width
        const savedWidth = loadSavedWidth();
        applyWidth(savedWidth);
        
        // Throttle resize updates using requestAnimationFrame
        let rafId = null;
        
        // Mouse down on resize handle
        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            document.body.style.cursor = 'ew-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });
        
        // Mouse move - resize sidebar (throttled with RAF)
        document.addEventListener('mousemove', function(e) {
            if (!isResizing) return;
            
            // Cancel previous frame if still pending
            if (rafId !== null) {
                cancelAnimationFrame(rafId);
            }
            
            // Schedule update for next frame
            rafId = requestAnimationFrame(function() {
                // Calculate new width based on mouse position from right edge
                const newWidth = window.innerWidth - e.clientX;
                
                // Validate width is within reasonable bounds before applying
                if (newWidth > 0 && newWidth < window.innerWidth) {
                    applyWidth(newWidth, true);  // Update CSS during resize
                }
                rafId = null;
            });
        });
        
        // Mouse up - stop resizing and save width
        document.addEventListener('mouseup', function() {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // Cancel any pending RAF
                if (rafId !== null) {
                    cancelAnimationFrame(rafId);
                    rafId = null;
                }
                
                saveWidth(currentWidth);
            }
        });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initResize);
    } else {
        initResize();
    }
})();
</script>
