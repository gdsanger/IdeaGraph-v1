{% extends "main/base.html" %}

{% block title %}Weaviate Status - IdeaGraph v1.0{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4 fade-in-up">
        <div class="col-lg-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-4 fw-bold mb-3" style="color: var(--autumn-light);">
                        <i class="bi bi-database-fill-gear"></i> Weaviate Status
                    </h1>
                    <p class="lead" style="color: #d1d5db;">
                        Monitor Weaviate database health and statistics
                    </p>
                </div>
                <div>
                    <a href="{% url 'main:weaviate_maintenance' %}" class="btn btn-primary">
                        <i class="bi bi-tools"></i> Maintenance
                    </a>
                    <a href="{% url 'main:settings' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Settings
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="text-center py-5">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading Weaviate status...</p>
    </div>

    <!-- Content Area (Hidden initially) -->
    <div id="status-content" style="display: none;">
        <!-- System Information -->
        <div class="row mb-4 fade-in-up">
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-info-circle-fill fs-2 text-primary me-3"></i>
                            <h3 class="h5 mb-0">System Information</h3>
                        </div>
                        <div class="mb-2">
                            <strong>Version:</strong>
                            <span id="weaviate-version" class="text-muted">-</span>
                        </div>
                        <div class="mb-2">
                            <strong>Hostname:</strong>
                            <span id="weaviate-hostname" class="text-muted">-</span>
                        </div>
                        <div>
                            <strong>Status:</strong>
                            <span id="weaviate-status" class="badge bg-success">Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-collection-fill fs-2 text-info me-3"></i>
                            <h3 class="h5 mb-0">Collection Statistics</h3>
                        </div>
                        <div class="mb-2">
                            <strong>Collection:</strong>
                            <span id="collection-name" class="text-muted">-</span>
                        </div>
                        <div class="mb-2">
                            <strong>Total Objects:</strong>
                            <span id="total-objects" class="badge bg-info">0</span>
                        </div>
                        <div>
                            <strong>Last Updated:</strong>
                            <span id="last-updated" class="text-muted small">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-12 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <i class="bi bi-activity fs-2 text-success me-3"></i>
                            <h3 class="h5 mb-0">Quick Actions</h3>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="refresh-status-btn" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-arrow-clockwise"></i> Refresh Status
                            </button>
                            <a href="{% url 'main:weaviate_maintenance' %}" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-tools"></i> Open Maintenance
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Objects by Type -->
        <div class="row mb-4 fade-in-up">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="h5 mb-0">
                            <i class="bi bi-pie-chart-fill"></i> Objects by Type
                        </h3>
                    </div>
                    <div class="card-body">
                        <div id="objects-by-type" class="row g-3">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Raw Metadata -->
        <div class="row fade-in-up">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="h5 mb-0">
                                <i class="bi bi-code-square"></i> Raw Metadata
                            </h3>
                            <button id="toggle-metadata-btn" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye"></i> Show
                            </button>
                        </div>
                    </div>
                    <div id="raw-metadata" class="card-body" style="display: none;">
                        <pre id="metadata-content" class="mb-0" style="background: #1a1a1a; padding: 1rem; border-radius: 0.5rem; color: #d1d5db; font-size: 0.85rem; max-height: 500px; overflow-y: auto;"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div id="error-state" style="display: none;" class="alert alert-danger">
        <h4 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Error Loading Status</h4>
        <p id="error-message">Failed to load Weaviate status. Please check the connection and try again.</p>
        <hr>
        <button id="retry-btn" class="btn btn-danger">
            <i class="bi bi-arrow-clockwise"></i> Retry
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadingState = document.getElementById('loading-state');
    const statusContent = document.getElementById('status-content');
    const errorState = document.getElementById('error-state');
    const errorMessage = document.getElementById('error-message');

    function loadStatus() {
        // Show loading
        loadingState.style.display = 'block';
        statusContent.style.display = 'none';
        errorState.style.display = 'none';

        // Fetch status from API
        fetch('/api/weaviate/status', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update system information
                document.getElementById('weaviate-version').textContent = data.version || 'Unknown';
                document.getElementById('weaviate-hostname').textContent = data.hostname || 'Unknown';
                
                // Update collection statistics
                document.getElementById('collection-name').textContent = data.stats?.collection_name || 'KnowledgeObject';
                document.getElementById('total-objects').textContent = data.stats?.total_objects || 0;
                document.getElementById('last-updated').textContent = new Date(data.stats?.timestamp).toLocaleString();

                // Update objects by type
                const objectsByTypeDiv = document.getElementById('objects-by-type');
                objectsByTypeDiv.innerHTML = '';
                
                if (data.stats?.objects_by_type) {
                    const types = Object.entries(data.stats.objects_by_type);
                    types.forEach(([type, count]) => {
                        const col = document.createElement('div');
                        col.className = 'col-lg-3 col-md-4 col-sm-6';
                        col.innerHTML = `
                            <div class="card text-center">
                                <div class="card-body">
                                    <h4 class="h2 mb-2 text-primary">${count}</h4>
                                    <p class="mb-0 text-muted">${type}</p>
                                </div>
                            </div>
                        `;
                        objectsByTypeDiv.appendChild(col);
                    });
                }

                // Update raw metadata
                document.getElementById('metadata-content').textContent = JSON.stringify(data.meta, null, 2);

                // Show content
                loadingState.style.display = 'none';
                statusContent.style.display = 'block';
            } else {
                throw new Error(data.error || 'Failed to load status');
            }
        })
        .catch(error => {
            console.error('Error loading status:', error);
            errorMessage.textContent = error.message || 'Failed to load Weaviate status. Please check the connection and try again.';
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
        });
    }

    // Load status on page load
    loadStatus();

    // Refresh button
    document.getElementById('refresh-status-btn').addEventListener('click', loadStatus);
    document.getElementById('retry-btn').addEventListener('click', loadStatus);

    // Toggle metadata
    document.getElementById('toggle-metadata-btn').addEventListener('click', function() {
        const metadata = document.getElementById('raw-metadata');
        const btn = this;
        if (metadata.style.display === 'none') {
            metadata.style.display = 'block';
            btn.innerHTML = '<i class="bi bi-eye-slash"></i> Hide';
        } else {
            metadata.style.display = 'none';
            btn.innerHTML = '<i class="bi bi-eye"></i> Show';
        }
    });
});
</script>
{% endblock %}
