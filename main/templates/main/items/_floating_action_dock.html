{% load static %}
<!-- Floating Action Dock -->
<div class="floating-action-dock">
    <!-- Chat Button -->
    <button type="button" 
            class="btn floating-action-btn" 
            data-bs-toggle="modal" 
            data-bs-target="#qaChatModal"
            title="Q&A Chat">
        <i class="bi bi-chat-dots"></i>
    </button>
    
    <!-- Graph Button -->
    <button type="button" 
            class="btn floating-action-btn" 
            data-bs-toggle="modal" 
            data-bs-target="#graphModal"
            title="Relationship Graph">
        <i class="bi bi-diagram-3"></i>
    </button>
</div>

<!-- Q&A Chat Modal -->
<div class="modal fade draggable-modal" id="qaChatModal" tabindex="-1" aria-labelledby="qaChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable resizable-modal">
        <div class="modal-content bg-dark">
            <div class="modal-header draggable-handle" style="cursor: move;">
                <h5 class="modal-title" id="qaChatModalLabel">
                    <i class="bi bi-chat-dots"></i> IdeaGraph Q&A Assistant
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="min-height: 600px;">
                <p class="text-muted" style="font-size: 0.9rem;">
                    Stelle Fragen zu diesem Item. Der IdeaGraph Assistant durchsucht automatisch alle zugeh√∂rigen Tasks, Files, Kommentare und Dokumentationen und generiert eine fundierte Antwort mit Quellenangaben.
                </p>
                
                <!-- Chat Widget Container -->
                <div id="ideagraph-chat-widget-modal"></div>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle"></div>
        </div>
    </div>
</div>

<!-- Graph Modal -->
<div class="modal fade draggable-modal" id="graphModal" tabindex="-1" aria-labelledby="graphModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable resizable-modal">
        <div class="modal-content bg-dark">
            <div class="modal-header draggable-handle" style="cursor: move;">
                <h5 class="modal-title" id="graphModalLabel">
                    <i class="bi bi-diagram-3"></i> Semantic Relationship Graph
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="min-height: 600px;">
                <div id="semanticNetworkModalContainer" style="width: 100%; height: 550px;"></div>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle"></div>
        </div>
    </div>
</div>

<style>
    /* Floating Action Dock Styles */
    .floating-action-dock {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 1050;
    }
    
    .floating-action-btn {
        border-radius: 50%;
        width: 56px;
        height: 56px;
        background-color: var(--primary-amber);
        color: var(--soft-white);
        box-shadow: 0 4px 12px rgba(228, 154, 40, 0.4);
        transition: all 0.2s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        font-size: 1.5rem;
    }
    
    .floating-action-btn:hover {
        background-color: var(--secondary-cyan);
        color: var(--graph-gray);
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(75, 208, 199, 0.5);
    }
    
    .floating-action-btn:active {
        transform: scale(0.95);
    }
    
    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .floating-action-dock {
            right: 10px;
        }
        
        .floating-action-btn {
            width: 48px;
            height: 48px;
            font-size: 1.25rem;
        }
    }
    
    @media (max-width: 768px) {
        .floating-action-dock {
            bottom: 20px;
            top: auto;
            right: 20px;
            transform: none;
            flex-direction: row;
            gap: 0.75rem;
        }
        
        .floating-action-btn {
            width: 52px;
            height: 52px;
        }
    }
    
    /* Draggable and Resizable Modal Styles */
    .draggable-modal .modal-dialog {
        margin: 0;
        max-width: none;
        width: auto;
        pointer-events: all;
    }
    
    .draggable-modal.show .modal-dialog {
        transform: none !important;
    }
    
    .draggable-handle {
        cursor: move;
        user-select: none;
    }
    
    .resizable-modal {
        position: absolute;
        resize: none;
        min-width: 400px;
        min-height: 300px;
    }
    
    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 20px;
        height: 20px;
        cursor: nwse-resize;
        z-index: 1;
    }
    
    .resize-handle::after {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 0 12px 12px;
        border-color: transparent transparent rgba(255, 255, 255, 0.3) transparent;
    }
    
    .modal-dialog.resizing,
    .modal-dialog.dragging {
        transition: none !important;
    }
</style>

<script>
// Initialize Chat Widget for Modal (lazy load when modal is shown)
let chatWidgetModalInitialized = false;

document.addEventListener('DOMContentLoaded', function() {
    const qaChatModal = document.getElementById('qaChatModal');
    if (qaChatModal) {
        qaChatModal.addEventListener('shown.bs.modal', function() {
            if (!chatWidgetModalInitialized) {
                try {
                    const chatWidget = new ChatWidget({
                        containerId: 'ideagraph-chat-widget-modal',
                        itemId: '{{ item.id }}',
                        apiBaseUrl: '/api/items',
                        theme: 'dark',
                        height: '500px',
                        showHistory: true
                    });
                    chatWidgetModalInitialized = true;
                    console.log('Chat widget initialized in modal');
                } catch (error) {
                    console.error('Error initializing chat widget in modal:', error);
                }
            }
        });
    }
});

// Initialize Semantic Network for Modal (lazy load when modal is shown)
let semanticNetworkModalInitialized = false;

document.addEventListener('DOMContentLoaded', function() {
    const graphModal = document.getElementById('graphModal');
    if (graphModal) {
        graphModal.addEventListener('shown.bs.modal', function() {
            if (!semanticNetworkModalInitialized) {
                try {
                    const semanticNetworkModalViewer = new SemanticGraph('semanticNetworkModalContainer', {
                        objectType: 'item',
                        objectId: '{{ item.id }}',
                        depth: 3,
                        generateSummaries: true,
                        includeHierarchy: true,
                        onNodeClick: function(nodeData) {
                            const type = nodeData.type;
                            const id = nodeData.id;
                            
                            if (type === 'item') {
                                window.location.href = `/items/${id}/`;
                            } else if (type === 'task') {
                                window.location.href = `/tasks/${id}/`;
                            }
                        }
                    });
                    semanticNetworkModalInitialized = true;
                    console.log('Semantic network initialized in modal');
                } catch (error) {
                    console.error('Error initializing semantic network in modal:', error);
                }
            }
        });
    }
});
</script>

<script>
// Draggable and Resizable Modal Functionality with localStorage
(function() {
    const STORAGE_PREFIX = 'floatingModal_';
    const DEFAULT_WIDTH = 1140; // Bootstrap modal-xl default
    const DEFAULT_HEIGHT = 700;
    const MIN_WIDTH = 400;
    const MIN_HEIGHT = 300;
    
    // Initialize draggable and resizable functionality for modals
    function initDraggableResizableModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        const modalDialog = modal.querySelector('.modal-dialog');
        const modalHeader = modal.querySelector('.draggable-handle');
        const resizeHandle = modal.querySelector('.resize-handle');
        
        if (!modalDialog || !modalHeader || !resizeHandle) return;
        
        let isDragging = false;
        let isResizing = false;
        let startX, startY, startLeft, startTop, startWidth, startHeight;
        
        // Load saved dimensions and position from localStorage
        function loadModalState() {
            const savedState = localStorage.getItem(STORAGE_PREFIX + modalId);
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    if (state.width) modalDialog.style.width = state.width + 'px';
                    if (state.height) modalDialog.style.height = state.height + 'px';
                    if (state.left !== undefined) modalDialog.style.left = state.left + 'px';
                    if (state.top !== undefined) modalDialog.style.top = state.top + 'px';
                } catch (e) {
                    console.error('Error loading modal state:', e);
                }
            } else {
                // Set default position (centered)
                centerModal();
            }
        }
        
        // Save dimensions and position to localStorage
        function saveModalState() {
            const rect = modalDialog.getBoundingClientRect();
            const state = {
                width: rect.width,
                height: rect.height,
                left: modalDialog.offsetLeft,
                top: modalDialog.offsetTop
            };
            localStorage.setItem(STORAGE_PREFIX + modalId, JSON.stringify(state));
        }
        
        // Center modal on screen
        function centerModal() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const width = parseInt(modalDialog.style.width) || DEFAULT_WIDTH;
            const height = parseInt(modalDialog.style.height) || DEFAULT_HEIGHT;
            
            modalDialog.style.width = width + 'px';
            modalDialog.style.height = height + 'px';
            modalDialog.style.left = Math.max(0, (viewportWidth - width) / 2) + 'px';
            modalDialog.style.top = Math.max(0, (viewportHeight - height) / 2) + 'px';
        }
        
        // Dragging functionality
        modalHeader.addEventListener('mousedown', function(e) {
            // Don't start drag if clicking on close button or other interactive elements
            if (e.target.closest('.btn-close') || e.target.closest('button')) {
                return;
            }
            
            isDragging = true;
            modalDialog.classList.add('dragging');
            
            startX = e.clientX;
            startY = e.clientY;
            startLeft = modalDialog.offsetLeft;
            startTop = modalDialog.offsetTop;
            
            e.preventDefault();
        });
        
        // Resizing functionality
        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            modalDialog.classList.add('resizing');
            
            startX = e.clientX;
            startY = e.clientY;
            startWidth = modalDialog.offsetWidth;
            startHeight = modalDialog.offsetHeight;
            
            e.preventDefault();
            e.stopPropagation();
        });
        
        // Mouse move handler
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;
                
                // Keep modal within viewport bounds
                const maxLeft = window.innerWidth - modalDialog.offsetWidth;
                const maxTop = window.innerHeight - modalDialog.offsetHeight;
                
                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));
                
                modalDialog.style.left = newLeft + 'px';
                modalDialog.style.top = newTop + 'px';
            }
            
            if (isResizing) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newWidth = startWidth + dx;
                let newHeight = startHeight + dy;
                
                // Apply minimum size constraints
                newWidth = Math.max(MIN_WIDTH, newWidth);
                newHeight = Math.max(MIN_HEIGHT, newHeight);
                
                // Keep within viewport
                const maxWidth = window.innerWidth - modalDialog.offsetLeft;
                const maxHeight = window.innerHeight - modalDialog.offsetTop;
                
                newWidth = Math.min(newWidth, maxWidth);
                newHeight = Math.min(newHeight, maxHeight);
                
                modalDialog.style.width = newWidth + 'px';
                modalDialog.style.height = newHeight + 'px';
            }
        });
        
        // Mouse up handler
        document.addEventListener('mouseup', function() {
            if (isDragging || isResizing) {
                modalDialog.classList.remove('dragging', 'resizing');
                saveModalState();
            }
            isDragging = false;
            isResizing = false;
        });
        
        // Load state when modal is shown
        modal.addEventListener('shown.bs.modal', function() {
            loadModalState();
        });
        
        // Initialize on page load if modal is visible
        if (modal.classList.contains('show')) {
            loadModalState();
        }
    }
    
    // Initialize both modals on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        initDraggableResizableModal('qaChatModal');
        initDraggableResizableModal('graphModal');
    });
})();
</script>
