{% load static %}
<!-- Floating Action Dock -->
<div class="floating-action-dock" data-context="{{ dock_context|default:'item' }}">
    <!-- Chat Button (Item View only) -->
    <button type="button" 
            class="btn floating-action-btn floating-action-btn-chat" 
            data-bs-toggle="modal" 
            data-bs-target="#qaChatModal"
            data-context="item"
            title="Q&A Chat">
        <i class="bi bi-chat-dots"></i>
    </button>
    
    <!-- Graph Button (Item & Task Views) -->
    <button type="button" 
            class="btn floating-action-btn floating-action-btn-graph" 
            data-bs-toggle="modal" 
            data-bs-target="#graphModal"
            data-context="item,task"
            title="Relationship Graph">
        <i class="bi bi-diagram-3"></i>
    </button>
    
    <!-- Files Button (Item & Task Views) -->
    <button type="button" 
            class="btn floating-action-btn floating-action-btn-files" 
            data-bs-toggle="modal" 
            data-bs-target="#filesModal"
            data-context="item,task"
            title="Files">
        <i class="bi bi-folder"></i>
    </button>
    
    <!-- Global Search Button (All Views) -->
    <button type="button" 
            class="btn floating-action-btn floating-action-btn-search" 
            data-bs-toggle="modal" 
            data-bs-target="#globalSearchModal"
            data-context="item,task,global"
            title="Global Search">
        <i class="bi bi-search"></i>
    </button>
</div>

<!-- Q&A Chat Modal -->
<div class="modal fade draggable-modal" id="qaChatModal" tabindex="-1" aria-labelledby="qaChatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable resizable-modal">
        <div class="modal-content bg-dark">
            <div class="modal-header draggable-handle">
                <h5 class="modal-title" id="qaChatModalLabel">
                    <i class="bi bi-chat-dots"></i> IdeaGraph Q&A Assistant
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="min-height: 600px;">
                <p class="text-muted" style="font-size: 0.9rem;">
                    Stelle Fragen zu diesem Item. Der IdeaGraph Assistant durchsucht automatisch alle zugehörigen Tasks, Files, Kommentare und Dokumentationen und generiert eine fundierte Antwort mit Quellenangaben.
                </p>
                
                <!-- Chat Widget Container -->
                <div id="ideagraph-chat-widget-modal"></div>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle"></div>
        </div>
    </div>
</div>

<!-- Graph Modal -->
<div class="modal fade draggable-modal" id="graphModal" tabindex="-1" aria-labelledby="graphModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable resizable-modal">
        <div class="modal-content bg-dark">
            <div class="modal-header draggable-handle">
                <h5 class="modal-title" id="graphModalLabel">
                    <i class="bi bi-diagram-3"></i> Semantic Relationship Graph
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="min-height: 600px;">
                <div id="semanticNetworkModalContainer" style="width: 100%; height: 550px;"></div>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle"></div>
        </div>
    </div>
</div>

<!-- Files Modal -->
<div class="modal fade draggable-modal" id="filesModal" tabindex="-1" aria-labelledby="filesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable resizable-modal">
        <div class="modal-content bg-dark">
            <div class="modal-header draggable-handle">
                <h5 class="modal-title" id="filesModalLabel">
                    <i class="bi bi-folder"></i> Files
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="min-height: 400px;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <p class="text-muted mb-0" style="font-size: 0.9rem;">
                        Alle Dateien dieses {{ object_type|default:'item' }}s
                    </p>
                    <button type="button" class="btn btn-sm btn-primary" id="uploadFileBtn">
                        <i class="bi bi-upload"></i> Datei hochladen
                    </button>
                </div>
                <div id="filesModalContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Laden...</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle"></div>
        </div>
    </div>
</div>

<!-- Global Search Modal -->
<div class="modal fade draggable-modal" id="globalSearchModal" tabindex="-1" aria-labelledby="globalSearchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable resizable-modal">
        <div class="modal-content bg-dark">
            <div class="modal-header draggable-handle">
                <h5 class="modal-title" id="globalSearchModalLabel">
                    <i class="bi bi-search"></i> Globale Semantische Suche
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="min-height: 400px;">
                <p class="text-muted mb-3" style="font-size: 0.9rem;">
                    Durchsuche alle Items, Tasks, Files und Knowledge Objects mit KI-gestützter Suche
                </p>
                
                <!-- Search Type Selector -->
                <div class="mb-3">
                    <label class="form-label text-muted" style="font-size: 0.85rem;">Suchmethode:</label>
                    <div class="btn-group w-100" role="group" aria-label="Search type selector">
                        <input type="radio" class="btn-check" name="searchTypeModal" id="searchTypeHybridModal" value="hybrid" checked autocomplete="off">
                        <label class="btn btn-outline-primary" for="searchTypeHybridModal" title="Kombiniert semantische und Keyword-Suche für beste Ergebnisse">
                            <i class="bi bi-stars"></i> Hybrid
                        </label>
                        
                        <input type="radio" class="btn-check" name="searchTypeModal" id="searchTypeNeartextModal" value="neartext" autocomplete="off">
                        <label class="btn btn-outline-primary" for="searchTypeNeartextModal" title="Rein semantische Vektorsuche basierend auf Bedeutung">
                            <i class="bi bi-bezier2"></i> Semantic
                        </label>
                        
                        <input type="radio" class="btn-check" name="searchTypeModal" id="searchTypeBm25Modal" value="bm25" autocomplete="off">
                        <label class="btn btn-outline-primary" for="searchTypeBm25Modal" title="Klassische Keyword-Suche (BM25)">
                            <i class="bi bi-search"></i> Keyword
                        </label>
                    </div>
                </div>
                
                <!-- Search Input -->
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               id="globalSearchInput" 
                               placeholder="Suchbegriff oder Frage eingeben...">
                        <button class="btn btn-primary" type="button" id="globalSearchBtn">
                            <i class="bi bi-search"></i> Suchen
                        </button>
                    </div>
                </div>
                
                <!-- Search Results -->
                <div id="globalSearchResults">
                    <div class="text-muted text-center py-4">
                        <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">Geben Sie einen Suchbegriff ein, um zu beginnen</p>
                    </div>
                </div>
            </div>
            <!-- Resize handle -->
            <div class="resize-handle"></div>
        </div>
    </div>
</div>

<style>
    /* Floating Action Dock Styles */
    .floating-action-dock {
        position: fixed;
        top: 50%;
        right: 20px;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 1050;
    }
    
    .floating-action-btn {
        border-radius: 50%;
        width: 56px;
        height: 56px;
        color: var(--soft-white);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transition: all 0.2s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        font-size: 1.5rem;
    }
    
    /* Chat Button - Cyan */
    .floating-action-btn-chat {
        background-color: var(--secondary-cyan);
        box-shadow: 0 4px 12px rgba(75, 208, 199, 0.4);
    }
    
    .floating-action-btn-chat:hover {
        background-color: #5dd4c7;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(75, 208, 199, 0.6);
    }
    
    /* Graph Button - Amber */
    .floating-action-btn-graph {
        background-color: var(--primary-amber);
        box-shadow: 0 4px 12px rgba(228, 154, 40, 0.4);
    }
    
    .floating-action-btn-graph:hover {
        background-color: #f5a524;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(228, 154, 40, 0.6);
    }
    
    /* Files Button - Neutral */
    .floating-action-btn-files {
        background-color: #6b7280;
        box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
    }
    
    .floating-action-btn-files:hover {
        background-color: #9ca3af;
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.6);
    }
    
    /* Search Button - Gradient Amber to Cyan */
    .floating-action-btn-search {
        background: linear-gradient(135deg, var(--primary-amber) 0%, var(--secondary-cyan) 100%);
        box-shadow: 0 4px 12px rgba(151, 181, 119, 0.4);
    }
    
    .floating-action-btn-search:hover {
        background: linear-gradient(135deg, #f5a524 0%, #5dd4c7 100%);
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(151, 181, 119, 0.6);
    }
    
    .floating-action-btn:active {
        transform: scale(0.95);
    }
    
    /* Context-based visibility */
    .floating-action-dock[data-context="item"] .floating-action-btn[data-context]:not([data-context*="item"]) {
        display: none;
    }
    
    .floating-action-dock[data-context="task"] .floating-action-btn[data-context]:not([data-context*="task"]) {
        display: none;
    }
    
    .floating-action-dock[data-context="global"] .floating-action-btn[data-context]:not([data-context*="global"]) {
        display: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1024px) {
        .floating-action-dock {
            right: 10px;
        }
        
        .floating-action-btn {
            width: 48px;
            height: 48px;
            font-size: 1.25rem;
        }
    }
    
    @media (max-width: 768px) {
        .floating-action-dock {
            bottom: 20px;
            top: auto;
            right: 20px;
            transform: none;
            flex-direction: row;
            gap: 0.75rem;
        }
        
        .floating-action-btn {
            width: 52px;
            height: 52px;
        }
    }
    
    /* Draggable and Resizable Modal Styles */
    .draggable-modal .modal-dialog {
        margin: 0;
        max-width: none;
        width: auto;
        pointer-events: all;
    }
    
    .draggable-modal.show .modal-dialog {
        transform: none !important;
    }
    
    .draggable-handle {
        cursor: move;
        user-select: none;
    }
    
    .resizable-modal {
        position: absolute;
        resize: none;
        min-width: 400px;
        min-height: 300px;
    }
    
    .resize-handle {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 20px;
        height: 20px;
        cursor: nwse-resize;
        z-index: 1;
    }
    
    .resize-handle::after {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 0 0 12px 12px;
        border-color: transparent transparent rgba(255, 255, 255, 0.3) transparent;
    }
    
    .modal-dialog.resizing,
    .modal-dialog.dragging {
        transition: none !important;
    }
    
    /* Files Modal Styles */
    .file-item {
        padding: 0.75rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        margin-bottom: 0.5rem;
        background: rgba(15, 23, 42, 0.4);
        transition: background 0.2s;
    }
    
    .file-item:hover {
        background: rgba(15, 23, 42, 0.6);
    }
    
    /* Search Results Styles */
    .search-result-item {
        padding: 1rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
        background: rgba(15, 23, 42, 0.4);
        transition: all 0.2s;
    }
    
    .search-result-item:hover {
        background: rgba(15, 23, 42, 0.6);
        border-color: var(--primary-amber);
    }
    
    .relevance-score {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary-amber) 0%, var(--secondary-cyan) 100%);
        color: white;
    }
</style>

<script>
// Initialize Chat Widget for Modal (lazy load when modal is shown)
let chatWidgetModalInitialized = false;

document.addEventListener('DOMContentLoaded', function() {
    const qaChatModal = document.getElementById('qaChatModal');
    if (qaChatModal) {
        qaChatModal.addEventListener('shown.bs.modal', function() {
            if (!chatWidgetModalInitialized) {
                try {
                    const objectType = '{{ object_type|default:"item" }}';
                    const objectId = '{{ object_id|escapejs }}';
                    const chatWidget = new ChatWidget({
                        containerId: 'ideagraph-chat-widget-modal',
                        itemId: objectId,
                        apiBaseUrl: `/api/${objectType}s`,
                        theme: 'dark',
                        height: '500px',
                        showHistory: true
                    });
                    chatWidgetModalInitialized = true;
                    console.log('Chat widget initialized in modal');
                } catch (error) {
                    console.error('Error initializing chat widget in modal:', error);
                }
            }
        });
    }
});

// Initialize Semantic Network for Modal (lazy load when modal is shown)
let semanticNetworkModalInitialized = false;

document.addEventListener('DOMContentLoaded', function() {
    const graphModal = document.getElementById('graphModal');
    if (graphModal) {
        graphModal.addEventListener('shown.bs.modal', function() {
            if (!semanticNetworkModalInitialized) {
                try {
                    const objectType = '{{ object_type|default:"item" }}';
                    const objectId = '{{ object_id|escapejs }}';
                    const semanticNetworkModalViewer = new SemanticGraph('semanticNetworkModalContainer', {
                        objectType: objectType,
                        objectId: objectId,
                        depth: 3,
                        generateSummaries: true,
                        includeHierarchy: objectType === 'item',
                        onNodeClick: function(nodeData) {
                            const type = nodeData.type;
                            const id = nodeData.id;
                            
                            if (type === 'item') {
                                window.location.href = `/items/${id}/`;
                            } else if (type === 'task') {
                                window.location.href = `/tasks/${id}/`;
                            }
                        }
                    });
                    semanticNetworkModalInitialized = true;
                    console.log('Semantic network initialized in modal');
                } catch (error) {
                    console.error('Error initializing semantic network in modal:', error);
                }
            }
        });
    }
});
</script>

<script>
// Draggable and Resizable Modal Functionality with localStorage
(function() {
    const STORAGE_PREFIX = 'floatingModal_';
    const DEFAULT_WIDTH = 1140; // Bootstrap modal-xl default
    const DEFAULT_HEIGHT = 700;
    const MIN_WIDTH = 400;
    const MIN_HEIGHT = 300;
    
    // Initialize draggable and resizable functionality for modals
    function initDraggableResizableModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        
        const modalDialog = modal.querySelector('.modal-dialog');
        const modalHeader = modal.querySelector('.draggable-handle');
        const resizeHandle = modal.querySelector('.resize-handle');
        
        if (!modalDialog || !modalHeader || !resizeHandle) return;
        
        let isDragging = false;
        let isResizing = false;
        let startX, startY, startLeft, startTop, startWidth, startHeight;
        let cachedModalWidth, cachedModalHeight; // Cache dimensions during drag
        
        // Load saved dimensions and position from localStorage
        function loadModalState() {
            const savedState = localStorage.getItem(STORAGE_PREFIX + modalId);
            if (savedState) {
                try {
                    const state = JSON.parse(savedState);
                    
                    // Validate and apply dimensions with min/max constraints
                    if (typeof state.width === 'number' && !isNaN(state.width)) {
                        const width = Math.max(MIN_WIDTH, Math.min(state.width, window.innerWidth));
                        modalDialog.style.width = width + 'px';
                    }
                    if (typeof state.height === 'number' && !isNaN(state.height)) {
                        const height = Math.max(MIN_HEIGHT, Math.min(state.height, window.innerHeight));
                        modalDialog.style.height = height + 'px';
                    }
                    
                    // Validate and apply position to keep modal within viewport
                    if (typeof state.left === 'number' && !isNaN(state.left) && 
                        typeof state.top === 'number' && !isNaN(state.top)) {
                        const modalWidth = parseInt(modalDialog.style.width) || DEFAULT_WIDTH;
                        const modalHeight = parseInt(modalDialog.style.height) || DEFAULT_HEIGHT;
                        
                        // Ensure modal stays within viewport bounds
                        const maxLeft = Math.max(0, window.innerWidth - modalWidth);
                        const maxTop = Math.max(0, window.innerHeight - modalHeight);
                        
                        const left = Math.max(0, Math.min(state.left, maxLeft));
                        const top = Math.max(0, Math.min(state.top, maxTop));
                        
                        modalDialog.style.left = left + 'px';
                        modalDialog.style.top = top + 'px';
                    } else {
                        // If position data is invalid or missing, center the modal
                        centerModal();
                    }
                } catch (e) {
                    console.error('Error loading modal state:', e);
                    centerModal();
                }
            } else {
                // Set default position (centered)
                centerModal();
            }
        }
        
        // Save dimensions and position to localStorage
        function saveModalState() {
            const rect = modalDialog.getBoundingClientRect();
            const state = {
                width: rect.width,
                height: rect.height,
                left: modalDialog.offsetLeft,
                top: modalDialog.offsetTop
            };
            localStorage.setItem(STORAGE_PREFIX + modalId, JSON.stringify(state));
        }
        
        // Center modal on screen
        function centerModal() {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const width = parseInt(modalDialog.style.width) || DEFAULT_WIDTH;
            const height = parseInt(modalDialog.style.height) || DEFAULT_HEIGHT;
            
            modalDialog.style.width = width + 'px';
            modalDialog.style.height = height + 'px';
            modalDialog.style.left = Math.max(0, (viewportWidth - width) / 2) + 'px';
            modalDialog.style.top = Math.max(0, (viewportHeight - height) / 2) + 'px';
        }
        
        // Dragging functionality
        modalHeader.addEventListener('mousedown', function(e) {
            // Don't start drag if clicking on close button or other interactive elements
            if (e.target.closest('.btn-close') || e.target.closest('button')) {
                return;
            }
            
            isDragging = true;
            modalDialog.classList.add('dragging');
            
            startX = e.clientX;
            startY = e.clientY;
            startLeft = modalDialog.offsetLeft;
            startTop = modalDialog.offsetTop;
            // Cache dimensions at drag start for consistent bounds checking
            cachedModalWidth = modalDialog.offsetWidth;
            cachedModalHeight = modalDialog.offsetHeight;
            
            e.preventDefault();
        });
        
        // Resizing functionality
        resizeHandle.addEventListener('mousedown', function(e) {
            isResizing = true;
            modalDialog.classList.add('resizing');
            
            startX = e.clientX;
            startY = e.clientY;
            startWidth = modalDialog.offsetWidth;
            startHeight = modalDialog.offsetHeight;
            
            e.preventDefault();
            e.stopPropagation();
        });
        
        // Mouse move handler
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newLeft = startLeft + dx;
                let newTop = startTop + dy;
                
                // Keep modal within viewport bounds using cached dimensions
                const maxLeft = window.innerWidth - cachedModalWidth;
                const maxTop = window.innerHeight - cachedModalHeight;
                
                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));
                
                modalDialog.style.left = newLeft + 'px';
                modalDialog.style.top = newTop + 'px';
            }
            
            if (isResizing) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newWidth = startWidth + dx;
                let newHeight = startHeight + dy;
                
                // Apply minimum size constraints
                newWidth = Math.max(MIN_WIDTH, newWidth);
                newHeight = Math.max(MIN_HEIGHT, newHeight);
                
                // Keep within viewport
                const maxWidth = window.innerWidth - modalDialog.offsetLeft;
                const maxHeight = window.innerHeight - modalDialog.offsetTop;
                
                newWidth = Math.min(newWidth, maxWidth);
                newHeight = Math.min(newHeight, maxHeight);
                
                modalDialog.style.width = newWidth + 'px';
                modalDialog.style.height = newHeight + 'px';
            }
        });
        
        // Mouse up handler
        document.addEventListener('mouseup', function() {
            if (isDragging || isResizing) {
                modalDialog.classList.remove('dragging', 'resizing');
                saveModalState();
            }
            isDragging = false;
            isResizing = false;
        });
        
        // Load state when modal is shown
        modal.addEventListener('shown.bs.modal', function() {
            loadModalState();
        });
        
        // Initialize on page load if modal is visible
        if (modal.classList.contains('show')) {
            loadModalState();
        }
    }
    
    // Initialize both modals on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        initDraggableResizableModal('qaChatModal');
        initDraggableResizableModal('graphModal');
        initDraggableResizableModal('filesModal');
        initDraggableResizableModal('globalSearchModal');
    });
})();
</script>

<script>
// Files Modal - Lazy Loading
let filesModalInitialized = false;

document.addEventListener('DOMContentLoaded', function() {
    const filesModal = document.getElementById('filesModal');
    if (filesModal) {
        filesModal.addEventListener('shown.bs.modal', function() {
            if (!filesModalInitialized) {
                loadFiles();
                filesModalInitialized = true;
            }
        });
    }
    
    // Upload file button handler
    const uploadBtn = document.getElementById('uploadFileBtn');
    if (uploadBtn) {
        uploadBtn.addEventListener('click', function() {
            // Trigger file upload - this will depend on your existing upload mechanism
            const objectType = '{{ object_type|default:"item" }}';
            const objectId = '{{ object_id|escapejs }}';
            window.location.href = `/${objectType}s/${objectId}/?upload=true`;
        });
    }
});

function loadFiles() {
    const objectType = '{{ object_type|default:"item" }}';
    const objectId = '{{ object_id|escapejs }}';
    const filesContent = document.getElementById('filesModalContent');
    
    if (!objectId) {
        filesContent.innerHTML = '<div class="alert alert-warning">Keine ID verfügbar</div>';
        return;
    }
    
    fetch(`/api/${objectType}s/${objectId}/files`)
        .then(response => response.json())
        .then(data => {
            if (data.files && data.files.length > 0) {
                let html = '<div class="files-list">';
                data.files.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">
                                        <i class="bi bi-file-earmark-text"></i>
                                        ${escapeHtml(file.name || file.filename)}
                                    </h6>
                                    <small class="text-muted">
                                        ${file.size ? formatFileSize(file.size) : 'Unknown size'} • 
                                        ${file.created_at ? new Date(file.created_at).toLocaleDateString('de-DE') : 'Unknown date'}
                                        ${file.source ? ' • ' + escapeHtml(file.source) : ''}
                                    </small>
                                </div>
                                <div>
                                    ${file.download_url ? `
                                        <a href="${file.download_url}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           download>
                                            <i class="bi bi-download"></i>
                                        </a>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                filesContent.innerHTML = html;
            } else {
                filesContent.innerHTML = `
                    <div class="text-muted text-center py-4">
                        <i class="bi bi-folder" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">Keine Dateien vorhanden</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading files:', error);
            filesContent.innerHTML = `
                <div class="alert alert-danger">
                    Fehler beim Laden der Dateien: ${escapeHtml(error.message)}
                </div>
            `;
        });
}

// Global Search Modal
document.addEventListener('DOMContentLoaded', function() {
    const globalSearchBtn = document.getElementById('globalSearchBtn');
    const globalSearchInput = document.getElementById('globalSearchInput');
    const globalSearchResults = document.getElementById('globalSearchResults');
    
    if (globalSearchBtn && globalSearchInput) {
        globalSearchBtn.addEventListener('click', performGlobalSearch);
        
        // Also search on Enter key
        globalSearchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performGlobalSearch();
            }
        });
    }
    
    function performGlobalSearch() {
        const query = globalSearchInput.value.trim();
        if (!query) {
            return;
        }
        
        // Get selected search type
        const searchTypeRadio = document.querySelector('input[name="searchTypeModal"]:checked');
        const searchType = searchTypeRadio ? searchTypeRadio.value : 'hybrid';
        
        // Show loading state
        globalSearchResults.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Suche läuft...</span>
                </div>
                <p class="mt-2 text-muted">Durchsuche mit ${searchType}...</p>
            </div>
        `;
        
        // Use GET request to match the API endpoint
        fetch(`/api/search?query=${encodeURIComponent(query)}&search_type=${searchType}&limit=20`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.results && data.results.length > 0) {
                let html = `<div class="mb-3 text-muted small">
                    ${data.total} Ergebnisse gefunden • ${searchType} Suche
                </div>
                <div class="search-results-list">`;
                
                data.results.forEach(result => {
                    const relevance = result.relevance || 0;
                    const relevancePercent = (relevance * 100).toFixed(1);
                    
                    html += `
                        <div class="search-result-item">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="flex-grow-1">
                                    ${result.type ? `<span class="badge bg-secondary me-2">${escapeHtml(result.type)}</span>` : ''}
                                    <strong>${escapeHtml(result.title || 'Untitled')}</strong>
                                </div>
                                <span class="relevance-score">${relevancePercent}%</span>
                            </div>
                            ${result.description ? `<p class="text-muted mb-2" style="font-size: 0.9rem;">${escapeHtml(result.description)}</p>` : ''}
                            <div class="d-flex justify-content-between align-items-center">
                                ${result.url ? `
                                    <a href="${escapeHtml(result.url)}" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="bi bi-box-arrow-up-right"></i> Öffnen
                                    </a>
                                ` : '<div></div>'}
                                ${result.metadata && result.metadata.section ? `
                                    <small class="text-muted">
                                        <i class="bi bi-folder"></i> ${escapeHtml(result.metadata.section)}
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                globalSearchResults.innerHTML = html;
            } else if (data.success) {
                globalSearchResults.innerHTML = `
                    <div class="text-muted text-center py-4">
                        <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="mt-2">Keine Ergebnisse gefunden für "${escapeHtml(query)}"</p>
                    </div>
                `;
            } else {
                globalSearchResults.innerHTML = `
                    <div class="alert alert-warning">
                        ${escapeHtml(data.error || 'Suche fehlgeschlagen')}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error performing search:', error);
            globalSearchResults.innerHTML = `
                <div class="alert alert-danger">
                    Fehler bei der Suche: ${escapeHtml(error.message)}
                </div>
            `;
        });
    }
});

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function truncateText(text, maxLength) {
    if (text.length <= maxLength) return text;
    return text.substr(0, maxLength) + '...';
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}
</script>
