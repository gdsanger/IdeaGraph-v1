{% extends "main/base.html" %}
{% load static %}

{% block title %}{{ item.title }} - Item Details{% endblock %}

{% block extra_css %}
<!-- Toast UI Editor CSS -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />

<style>
    .item-detail-card {
        background: rgba(31, 41, 55, 0.9);
    }
    
    .status-badge-large {
        font-size: 1.2rem;
        padding: 0.5rem 1rem;
    }
    
    .ai-button {
        position: relative;
    }
    
    .ai-button .spinner-border {
        display: none;
        width: 1rem;
        height: 1rem;
        margin-left: 0.5rem;
    }
    
    .ai-button.loading .spinner-border {
        display: inline-block;
    }
    
    .ai-button.loading .button-text {
        opacity: 0.7;
    }
    
    /* Fix Toast UI Editor markdown panel background to match the application theme */
    .toastui-editor-defaultUI .toastui-editor-main-container .toastui-editor-md-container,
    .toastui-editor-defaultUI .toastui-editor-main-container .toastui-editor-md-container .toastui-editor-md-splitter,
    .toastui-editor-defaultUI .toastui-editor-main-container .toastui-editor-md-vertical-style .toastui-editor-md-splitter {
        background-color: #ffffff;
    }
    
    .toastui-editor-defaultUI .toastui-editor-md-vertical-style .toastui-editor-md-preview {
        background-color: #ffffff;
    }
    
    .toastui-editor-defaultUI .ProseMirror {
        background-color: #ffffff;        
    }
    .tag-token-box {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: calc(2.5rem + 2px);
        padding: 0.35rem 0.5rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        background-color: rgba(15, 23, 42, 0.6);
        cursor: text;
    }

    .tag-token-box:focus-within {
        border-color: var(--autumn-accent);
        box-shadow: 0 0 0 0.2rem rgba(245, 158, 11, 0.25);
    }

    .tag-token {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.85rem;
        color: #fff;
        background-color: var(--autumn-primary);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .tag-token-remove {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
        padding: 0;
    }

    .tag-token-remove:hover {
        opacity: 0.8;
    }

    .tag-token-input {
        flex: 1 0 140px;
        min-width: 120px;
        border: none;
        background: transparent;
        color: inherit;
        padding: 0.35rem;
        font-size: 0.95rem;
    }

    .tag-token-input:focus {
        outline: none;
        box-shadow: none;
    }

</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'main:item_list' %}">Items</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ item.title }}</li>
        </ol>
    </nav>

    <!-- Item Details Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card item-detail-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-lightbulb"></i> Item Details
                    </h3>
                    <div>
                        {% if item.status == 'ready' %}
                        <span class="badge status-badge-large bg-success">ðŸŸ¢ {{ item.get_status_display }}</span>
                        {% elif item.status == 'spec_review' %}
                        <span class="badge status-badge-large bg-warning">ðŸŸ¡ {{ item.get_status_display }}</span>
                        {% elif item.status == 'working' %}
                        <span class="badge status-badge-large bg-primary">ðŸ”µ {{ item.get_status_display }}</span>
                        {% elif item.status == 'rejected' %}
                        <span class="badge status-badge-large bg-danger">ðŸ”´ {{ item.get_status_display }}</span>
                        {% elif item.status == 'done' %}
                        <span class="badge status-badge-large bg-secondary">âœ… {{ item.get_status_display }}</span>
                        {% else %}
                        <span class="badge status-badge-large bg-secondary">âšª {{ item.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="itemForm">
                        {% csrf_token %}
                        
                        <!-- Title -->
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <input type="text" class="form-control" id="title" name="title" value="{{ item.title }}" required>
                        </div>

                        <!-- Description with Toast UI Editor -->
                        <div class="mb-3">
                            <label for="description" class="form-label">Description (Markdown)</label>
                            <div id="editor"></div>
                            <textarea name="description" id="description" style="display: none;">{{ item.description }}</textarea>
                        </div>

                        <!-- GitHub Repository -->
                        <div class="mb-3">
                            <label for="github_repo" class="form-label">GitHub Repository</label>
                            <input type="text" class="form-control" id="github_repo" name="github_repo" value="{{ item.github_repo }}" placeholder="owner/repository">
                        </div>

                        <div class="row">
                            <!-- Section -->
                            <div class="col-md-4 mb-3">
                                <label for="section" class="form-label">Section</label>
                                <select class="form-select" id="section" name="section">
                                    <option value="">No Section</option>
                                    {% for section in sections %}
                                    <option value="{{ section.id }}" {% if item.section and item.section.id == section.id %}selected{% endif %}>{{ section.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Status -->
                            <div class="col-md-4 mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    {% for value, label in status_choices %}
                                    <option value="{{ value }}" {% if item.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Tags -->
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Tags</label>
                                <div id="itemDetailTagTokenBox" class="tag-token-box"></div>
                                <div id="itemDetailTagHiddenInputs"></div>
                                <small class="text-muted">Type a tag name and press Enter to add it. Existing tags will appear as suggestions.</small>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save
                            </button>
                            <a href="{% url 'main:item_delete' item.id %}" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                            <button type="button" class="btn btn-success ai-button" id="aiEnhanceBtn">
                                <span class="button-text"><i class="bi bi-stars"></i> AI Enhancer</span>
                                <span class="spinner-border" role="status"></span>
                            </button>
                            <button type="button" class="btn btn-info ai-button" id="buildTasksBtn" {% if item.status != 'ready' %}disabled title="Only available when status is Ready"{% endif %}>
                                <span class="button-text"><i class="bi bi-brain"></i> Build Tasks</span>
                                <span class="spinner-border" role="status"></span>
                            </button>
                            <button type="button" class="btn btn-warning ai-button" id="checkSimilarityBtn">
                                <span class="button-text"><i class="bi bi-search"></i> Check Similarity</span>
                                <span class="spinner-border" role="status"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs" id="itemTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="similar-tab" data-bs-toggle="tab" data-bs-target="#similar" type="button" role="tab">
                                <i class="bi bi-diagram-3"></i> Similar Items
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                                <i class="bi bi-list-task"></i> Tasks ({{ tasks.count }})
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="itemTabsContent">
                        <!-- Similar Items Tab -->
                        <div class="tab-pane fade show active" id="similar" role="tabpanel">
                            <div id="similarItemsContainer">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-diagram-3" style="font-size: 3rem;"></i>
                                    <p class="mt-3">Click "Check Similarity" to find related items</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tasks Tab -->
                        <div class="tab-pane fade" id="tasks" role="tabpanel">
                            <div class="mb-3">
                                <a href="{% url 'main:task_create' item.id %}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> New Task
                                </a>
                            </div>
                            
                            {% if tasks %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Status</th>
                                            <th>GitHub</th>
                                            <th>Assigned To</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for task in tasks %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'main:task_detail' task.id %}" class="text-decoration-none">
                                                    {{ task.title }}
                                                </a>
                                            </td>
                                            <td>
                                                {% if task.status == 'ready' %}
                                                <span class="badge bg-success">ðŸŸ¢ Ready</span>
                                                {% elif task.status == 'review' %}
                                                <span class="badge bg-warning">ðŸŸ¡ Review</span>
                                                {% elif task.status == 'working' %}
                                                <span class="badge bg-primary">ðŸ”µ Working</span>
                                                {% elif task.status == 'done' %}
                                                <span class="badge bg-secondary">âœ… Done</span>
                                                {% else %}
                                                <span class="badge bg-secondary">âšª New</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if task.github_issue_id %}
                                                <a href="{{ task.github_issue_url }}" target="_blank" class="text-decoration-none">
                                                    #{{ task.github_issue_id }} <i class="bi bi-box-arrow-up-right"></i>
                                                </a>
                                                {% else %}
                                                <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if task.assigned_to %}
                                                {{ task.assigned_to.username }}
                                                {% else %}
                                                <span class="text-muted">Unassigned</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ task.created_at|date:"Y-m-d" }}</small>
                                            </td>
                                            <td>
                                                <a href="{% url 'main:task_detail' task.id %}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                                <p class="mt-3">No tasks yet. Use "Build Tasks" to generate tasks from this item.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Toast UI Editor JS -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
{{ all_tags|json_script:"item-detail-all-tags" }}
{{ selected_tags|json_script:"item-detail-selected-tags" }}
<script src="{% static 'main/js/tag-token.js' %}"></script>

<script>
// Initialize Toast UI Editor
const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '400px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    initialValue: document.querySelector('#description').value
});

// Sync editor content to textarea before form submit
document.querySelector('#itemForm').addEventListener('submit', function() {
    document.querySelector('#description').value = editor.getMarkdown();
});

// Initialize tag token box
const itemDetailAllTags = JSON.parse(document.getElementById('item-detail-all-tags').textContent || '[]');
const itemDetailSelectedTags = JSON.parse(document.getElementById('item-detail-selected-tags').textContent || '[]');
initializeTagTokenBox('itemDetailTagTokenBox', {
    allTags: itemDetailAllTags,
    selectedTags: itemDetailSelectedTags,
    hiddenInputContainerId: 'itemDetailTagHiddenInputs',
    inputPlaceholder: 'Add a tag and press Enter'
});

// AI Enhance Button
document.querySelector('#aiEnhanceBtn').addEventListener('click', async function() {
    const btn = this;
    btn.classList.add('loading');
    btn.disabled = true;
    
    try {
        // TODO: Call API endpoint for AI enhancement
        alert('AI Enhancement feature will be implemented with KiGate API integration');
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
});

// Build Tasks Button
document.querySelector('#buildTasksBtn').addEventListener('click', async function() {
    const btn = this;
    btn.classList.add('loading');
    btn.disabled = true;
    
    try {
        // TODO: Call API endpoint for building tasks
        alert('Build Tasks feature will be implemented with KiGate API integration');
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
});

// Check Similarity Button
document.querySelector('#checkSimilarityBtn').addEventListener('click', async function() {
    const btn = this;
    btn.classList.add('loading');
    btn.disabled = true;
    
    try {
        // TODO: Call API endpoint for similarity check
        alert('Check Similarity feature will be implemented with ChromaDB integration');
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
});
</script>
{% endblock %}
