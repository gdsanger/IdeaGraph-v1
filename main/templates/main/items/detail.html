{% extends "main/base.html" %}
{% load static %}

{% block title %}{{ item.title }} - Item Details{% endblock %}

{% block extra_css %}
<!-- Toast UI Editor CSS -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" />
<!-- Semantic Network CSS -->
<link rel="stylesheet" href="{% static 'main/css/semantic-network.css' %}" />

<style>
    .item-detail-card {
        background: rgba(31, 41, 55, 0.9);
    }
    
    .status-badge-large {
        font-size: 1.2rem;
        padding: 0.5rem 1rem;
    }
    
    .ai-button {
        position: relative;
    }
    
    .ai-button .spinner-border {
        display: none;
        width: 1rem;
        height: 1rem;
        margin-left: 0.5rem;
    }
    
    .ai-button.loading .spinner-border {
        display: inline-block;
    }
    
    .ai-button.loading .button-text {
        opacity: 0.7;
    }
    
    /* Fix Toast UI Editor markdown panel background to match the application theme */
    .toastui-editor-defaultUI .toastui-editor-main-container .toastui-editor-md-container,
    .toastui-editor-defaultUI .toastui-editor-main-container .toastui-editor-md-container .toastui-editor-md-splitter,
    .toastui-editor-defaultUI .toastui-editor-main-container .toastui-editor-md-vertical-style .toastui-editor-md-splitter {
        background-color: #ffffff;
    }
    
    .toastui-editor-defaultUI .toastui-editor-md-vertical-style .toastui-editor-md-preview {
        background-color: #ffffff;
    }
    
    .toastui-editor-defaultUI .ProseMirror {
        background-color: #ffffff;        
    }
    .tag-token-box {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: calc(2.5rem + 2px);
        padding: 0.35rem 0.5rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        background-color: rgba(15, 23, 42, 0.6);
        cursor: text;
    }

    .tag-token-box:focus-within {
        border-color: var(--autumn-accent);
        box-shadow: 0 0 0 0.2rem rgba(245, 158, 11, 0.25);
    }

    .tag-token {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.25rem 0.75rem;
        border-radius: 999px;
        font-size: 0.85rem;
        color: #fff;
        background-color: var(--autumn-primary);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    .tag-token-remove {
        background: transparent;
        border: none;
        color: inherit;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
        padding: 0;
    }

    .tag-token-remove:hover {
        opacity: 0.8;
    }

    .tag-token-input {
        flex: 1 0 140px;
        min-width: 120px;
        border: none;
        background: transparent;
        color: inherit;
        padding: 0.35rem;
        font-size: 0.95rem;
    }

    .tag-token-input:focus {
        outline: none;
        box-shadow: none;
    }

    .htmx-indicator {
        display: none;
    }
    .htmx-request .htmx-indicator {
        display: block;
    }
    .htmx-request.htmx-indicator {
        display: block;
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'main:item_list' %}">Items</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ item.title }}</li>
        </ol>
    </nav>

    <!-- Two-Column Layout: Details + Semantic Network -->
    <div class="detail-container-with-network">
        <!-- Left Column: Item Details -->
        <div class="detail-left-column">
    
    <!-- Hierarchical Context Card -->
    {% if item.parent or item.children.all %}
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-2"></i> Hierarchische Beziehungen
                    </h5>
                </div>
                <div class="card-body">
                    {% if item.parent %}
                    <div class="mb-2">
                        <strong><i class="bi bi-arrow-up"></i> Parent Item:</strong>
                        <a href="{% url 'main:item_detail' item.parent.id %}" class="text-primary">{{ item.parent.title }}</a>
                        {% if item.inherit_context %}
                        <span class="badge bg-info ms-2">Kontext geerbt</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if item.is_template %}
                    <div class="mb-2">
                        <span class="badge bg-secondary"><i class="bi bi-file-earmark-code"></i> Template Item</span>
                    </div>
                    {% endif %}
                    {% if item.children.all %}
                    <div>
                        <strong><i class="bi bi-arrow-down"></i> Child Items ({{ item.children.count }}):</strong>
                        <ul class="list-unstyled mt-2 ms-3">
                            {% for child in item.children.all %}
                            <li class="mb-1">
                                <a href="{% url 'main:item_detail' child.id %}" class="text-primary">{{ child.title }}</a>
                                {% if child.inherit_context %}
                                <span class="badge bg-info badge-sm">erbt Kontext</span>
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Item Details Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card item-detail-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">
                        <i class="bi bi-lightbulb"></i> Item Details
                    </h3>
                    <div>
                        {% if item.status == 'ready' %}
                        <span class="badge status-badge-large bg-success">ðŸŸ¢ {{ item.get_status_display }}</span>
                        {% elif item.status == 'spec_review' %}
                        <span class="badge status-badge-large bg-warning">ðŸŸ¡ {{ item.get_status_display }}</span>
                        {% elif item.status == 'working' %}
                        <span class="badge status-badge-large bg-primary">ðŸ”µ {{ item.get_status_display }}</span>
                        {% elif item.status == 'rejected' %}
                        <span class="badge status-badge-large bg-danger">ðŸ”´ {{ item.get_status_display }}</span>
                        {% elif item.status == 'done' %}
                        <span class="badge status-badge-large bg-secondary">âœ… {{ item.get_status_display }}</span>
                        {% else %}
                        <span class="badge status-badge-large bg-secondary">âšª {{ item.get_status_display }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <form method="post" id="itemForm">
                        {% csrf_token %}
                        
                        <!-- Title -->
                        <div class="mb-3">
                            <label for="title" class="form-label">Title</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="title" name="title" value="{{ item.title }}" required>
                                <button type="button" class="btn btn-outline-success ai-button" id="generateTitleBtn" title="Generate title from description using AI">
                                    <i class="bi bi-stars"></i>
                                    <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                                </button>
                            </div>
                        </div>

                        <!-- Description with Toast UI Editor -->
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label for="description" class="form-label mb-0">Description (Markdown)</label>
                                <button type="button" class="btn btn-sm btn-outline-success ai-button" id="optimizeDescriptionBtn" title="Optimize description using AI">
                                    <i class="bi bi-stars"></i> Optimize Text
                                    <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                                </button>
                            </div>
                            <div id="editor"></div>
                            <textarea name="description" id="description" style="display: none;">{{ item.description }}</textarea>
                        </div>

                        <!-- GitHub Repository -->
                        <div class="mb-3">
                            <label for="github_repo" class="form-label">GitHub Repository</label>
                            <input type="text" class="form-control" id="github_repo" name="github_repo" value="{{ item.github_repo }}" placeholder="owner/repository">
                        </div>

                        <div class="row">
                            <!-- Section -->
                            <div class="col-md-4 mb-3">
                                <label for="section" class="form-label">Section</label>
                                <select class="form-select" id="section" name="section">
                                    <option value="">No Section</option>
                                    {% for section in sections %}
                                    <option value="{{ section.id }}" {% if item.section and item.section.id == section.id %}selected{% endif %}>{{ section.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Status -->
                            <div class="col-md-4 mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" name="status">
                                    {% for value, label in status_choices %}
                                    <option value="{{ value }}" {% if item.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Tags -->
                            <div class="col-md-4 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">Tags</label>
                                    <button type="button" class="btn btn-sm btn-outline-success ai-button" id="extractTagsBtn" title="Extract tags from description using AI">
                                        <i class="bi bi-stars"></i>
                                        <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                                    </button>
                                </div>
                                <div id="itemDetailTagTokenBox" class="tag-token-box"></div>
                                <div id="itemDetailTagHiddenInputs"></div>
                                <small class="text-muted">Type a tag name and press Enter to add it. Existing tags will appear as suggestions.</small>
                            </div>
                        </div>

                        <!-- Hierarchical fields -->
                        <div class="row">
                            <!-- Parent Item -->
                            <div class="col-md-4 mb-3">
                                <label for="parent" class="form-label">
                                    <i class="bi bi-diagram-2"></i> Parent Item
                                </label>
                                <select class="form-select" id="parent" name="parent">
                                    <option value="">No Parent</option>
                                    {% for parent_item in all_items %}
                                    {% if parent_item.id != item.id %}
                                    <option value="{{ parent_item.id }}" 
                                            {% if item.parent and item.parent.id == parent_item.id %}selected{% endif %}>
                                        {{ parent_item.title }}
                                    </option>
                                    {% endif %}
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Is Template -->
                            <div class="col-md-4 mb-3">
                                <label for="is_template" class="form-label">Template</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="is_template" name="is_template" 
                                           {% if item.is_template %}checked{% endif %}>
                                    <label class="form-check-label" for="is_template">
                                        Is template item
                                    </label>
                                </div>
                            </div>

                            <!-- Inherit Context -->
                            <div class="col-md-4 mb-3">
                                <label for="inherit_context" class="form-label">Context</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="inherit_context" name="inherit_context" 
                                           {% if item.inherit_context %}checked{% endif %}>
                                    <label class="form-check-label" for="inherit_context">
                                        Inherit from parent
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Save
                            </button>
                            <a href="{% url 'main:item_delete' item.id %}" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                            <button type="button" class="btn btn-success ai-button" id="aiEnhanceBtn">
                                <span class="button-text"><i class="bi bi-stars"></i> AI Enhancer</span>
                                <span class="spinner-border" role="status"></span>
                            </button>
                            <button type="button" class="btn btn-info ai-button" id="buildTasksBtn" {% if item.status != 'ready' %}disabled title="Only available when status is Ready"{% endif %}>
                                <span class="button-text"><i class="bi bi-brain"></i> Build Tasks</span>
                                <span class="spinner-border" role="status"></span>
                            </button>
                            <button type="button" class="btn btn-warning ai-button" id="checkSimilarityBtn">
                                <span class="button-text"><i class="bi bi-search"></i> Check Similarity</span>
                                <span class="spinner-border" role="status"></span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="syncGitHubIssuesBtn" 
                                    {% if not settings.github_api_enabled or not item.github_repo %}
                                    disabled 
                                    title="{% if not settings.github_api_enabled %}GitHub is not enabled{% elif not item.github_repo %}No GitHub repository set for this item{% endif %}"
                                    {% else %}
                                    title="Sync GitHub Issues to Tasks"
                                    {% endif %}>
                                <span class="button-text"><i class="bi bi-github"></i> Sync GitHub Issues</span>
                                <span class="spinner-border spinner-border-sm" role="status" style="display: none;"></span>
                            </button>
                            <button type="button" class="btn btn-secondary" id="sendEmailBtn" data-bs-toggle="modal" data-bs-target="#sendEmailModal">
                                <i class="bi bi-envelope"></i> Send via Email
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs" id="itemTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                                <i class="bi bi-file-earmark"></i> Files
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                                <i class="bi bi-list-task"></i> Tasks ({{ tasks.paginator.count }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="milestones-tab" data-bs-toggle="tab" data-bs-target="#milestones" type="button" role="tab">
                                <i class="bi bi-flag"></i> Milestones
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="itemTabsContent">
                        <!-- Files Tab -->
                        <div class="tab-pane fade show active" id="files" role="tabpanel">
                            <div class="mb-3">
                                <form id="fileUploadForm" 
                                      hx-post="/api/items/{{ item.id }}/files/upload" 
                                      hx-encoding="multipart/form-data"
                                      hx-target="#filesListContainer"
                                      hx-swap="innerHTML"
                                      hx-indicator="#uploadProgress">
                                    <label for="fileInputHtmx" class="btn btn-primary">
                                        <i class="bi bi-upload"></i> Upload File
                                    </label>
                                    <input type="file" 
                                           id="fileInputHtmx" 
                                           name="file" 
                                           style="display: none;"
                                           onchange="this.closest('form').dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}));" />
                                    <small class="text-muted ms-2">Maximum file size: 25 MB</small>
                                </form>
                            </div>
                            
                            <!-- Upload progress -->
                            <div id="uploadProgress" style="display: none;" class="mb-3 htmx-indicator">
                                <div class="progress">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>
                                <small class="text-muted">Processing file...</small>
                            </div>
                            
                            <!-- Files list - loaded via htmx -->
                            <div id="filesListContainer"
                                 hx-get="/api/items/{{ item.id }}/files"
                                 hx-trigger="load"
                                 hx-indicator="#uploadProgress">
                                <div class="text-center text-muted py-5">
                                    <i class="bi bi-file-earmark" style="font-size: 3rem;"></i>
                                    <p class="mt-3">Loading files...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tasks Tab -->
                        <div class="tab-pane fade" id="tasks" role="tabpanel">
                            <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <a href="{% url 'main:task_create' item.id %}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> New Task
                                </a>
                                <div class="d-flex align-items-center gap-2 flex-wrap">
                                    <form method="get" class="d-flex align-items-center gap-2" id="taskSearchForm">
                                        <input type="text" class="form-control" name="search" placeholder="Suche in Tasks..." value="{{ search_query }}" style="min-width: 200px;">
                                        <button type="submit" class="btn btn-outline-secondary">
                                            <i class="bi bi-search"></i>
                                        </button>
                                        {% if search_query %}
                                        <a href="?{% if show_completed %}show_completed=true{% endif %}" class="btn btn-outline-secondary" title="Clear search">
                                            <i class="bi bi-x-circle"></i>
                                        </a>
                                        {% endif %}
                                        <!-- Hidden field to preserve show_completed state -->
                                        {% if show_completed %}
                                        <input type="hidden" name="show_completed" value="true">
                                        {% endif %}
                                    </form>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="showCompletedSwitch" {% if show_completed %}checked{% endif %}>
                                        <label class="form-check-label" for="showCompletedSwitch">
                                            Erledigt anzeigen
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            {% if search_query %}
                            <div class="alert alert-info mb-3">
                                Suchergebnisse fÃ¼r "<strong>{{ search_query }}</strong>" - {{ tasks.paginator.count }} Task(s) gefunden
                            </div>
                            {% endif %}
                            
                            <!-- Loading indicator for HTMX requests -->
                            <div id="tasks-loading-indicator" class="htmx-indicator text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            
                            <!-- Task table container for HTMX updates -->
                            <div id="item-tasks-table-container">
                                {% include 'main/items/_item_tasks_table.html' %}
                            </div>
                        </div>
                        
                        <!-- Milestones Tab -->
                        <div class="tab-pane fade" id="milestones" role="tabpanel">
                            <div class="mb-3">
                                <a href="{% url 'main:milestone_create' item.id %}" class="btn btn-primary">
                                    <i class="bi bi-plus-circle"></i> New Milestone
                                </a>
                            </div>
                            
                            {% if item.milestones.all %}
                            <div class="list-group">
                                {% for milestone in item.milestones.all %}
                                <a href="{% url 'main:milestone_detail' milestone.id %}" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between align-items-center">
                                        <div class="flex-grow-1">
                                            <h5 class="mb-1">
                                                <i class="bi bi-flag-fill text-warning"></i>
                                                {{ milestone.name }}
                                            </h5>
                                            <p class="mb-1 text-muted">
                                                {% if milestone.description %}
                                                {{ milestone.description|truncatewords:20 }}
                                                {% else %}
                                                No description
                                                {% endif %}
                                            </p>
                                            <small class="text-muted">
                                                <i class="bi bi-calendar"></i> {{ milestone.due_date|date:"d.m.Y" }}
                                                {% if milestone.due_date < today %}
                                                    <span class="badge bg-danger ms-1">ÃœberfÃ¤llig</span>
                                                {% elif milestone.due_date <= week_from_today %}
                                                    <span class="badge bg-warning ms-1">Bald fÃ¤llig</span>
                                                {% endif %}
                                                â€¢ <i class="bi bi-list-task"></i> {{ milestone.tasks.count }} tasks
                                                â€¢ <i class="bi bi-collection"></i> {{ milestone.context_objects.count }} context objects
                                            </small>
                                        </div>
                                        <div>
                                            <span class="badge 
                                                {% if milestone.status == 'planned' %}bg-secondary
                                                {% elif milestone.status == 'in_progress' %}bg-primary
                                                {% elif milestone.status == 'completed' %}bg-success
                                                {% endif %}">
                                                {{ milestone.get_status_display }}
                                            </span>
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                No milestones yet. Click "New Milestone" to create one.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
        <!-- End Left Column -->
        
        <!-- Right Column: Semantic Network -->
        <div class="detail-right-column">
            <div id="semanticNetworkContainer"></div>
        </div>
        <!-- End Right Column -->
    </div>
    <!-- End Two-Column Layout -->

    <!-- Send Email Modal -->
    <div class="modal fade" id="sendEmailModal" tabindex="-1" aria-labelledby="sendEmailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content bg-dark">
                <div class="modal-header">
                    <h5 class="modal-title" id="sendEmailModalLabel">
                        <i class="bi bi-envelope"></i> Send Item via Email
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="sendEmailForm">
                        <div class="mb-3">
                            <label for="recipientEmail" class="form-label">Recipient Email Address</label>
                            <input type="email" class="form-control" id="recipientEmail" name="recipientEmail" required placeholder="recipient@example.com">
                            <div class="form-text">The item details and open tasks will be sent to this email address.</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmSendEmailBtn">
                        <i class="bi bi-send"></i> Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Toast UI Editor JS -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
{{ all_tags|json_script:"item-detail-all-tags" }}
{{ selected_tags|json_script:"item-detail-selected-tags" }}
<script src="{% static 'main/js/tag-token.js' %}"></script>

<!-- Sigma.js and dependencies for semantic network -->
<script src="https://cdn.jsdelivr.net/npm/graphology@0.25.1/dist/graphology.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/graphology-layout-forceatlas2@0.10.1/dist/graphology-layout-forceatlas2.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sigma@3.0.0-alpha3/build/sigma.min.js"></script>
<script src="{% static 'main/js/semantic-network.js' %}"></script>

<script>
// Tab state persistence: Save and restore last opened tab
// This must be loaded BEFORE other scripts that might fail
(function() {
    const STORAGE_KEY = 'itemDetailLastTab';
    
    // Function to activate a tab
    function activateTab(tabId) {
        // Get all tab buttons and panes
        const allTabButtons = document.querySelectorAll('#itemTabs button[data-bs-toggle="tab"]');
        const allTabPanes = document.querySelectorAll('#itemTabsContent .tab-pane');
        
        // Deactivate all tabs
        allTabButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-selected', 'false');
        });
        allTabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });
        
        // Activate the target tab
        const targetButton = document.querySelector(`#${tabId}`);
        if (targetButton) {
            const targetId = targetButton.getAttribute('data-bs-target');
            const targetPane = document.querySelector(targetId);
            
            targetButton.classList.add('active');
            targetButton.setAttribute('aria-selected', 'true');
            
            if (targetPane) {
                targetPane.classList.add('show', 'active');
            }
        }
    }
    
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        // Restore last opened tab on page load
        const lastTab = localStorage.getItem(STORAGE_KEY);
        if (lastTab) {
            activateTab(lastTab);
        }
        
        // Save tab state when user switches tabs
        const tabButtons = document.querySelectorAll('#itemTabs button[data-bs-toggle="tab"]');
        tabButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                // Save the ID of the clicked tab
                localStorage.setItem(STORAGE_KEY, this.id);
                // Manually activate the tab
                activateTab(this.id);
            });
        });
    });
})();

// Initialize Toast UI Editor
const editor = new toastui.Editor({
    el: document.querySelector('#editor'),
    height: '400px',
    initialEditType: 'markdown',
    previewStyle: 'vertical',
    initialValue: document.querySelector('#description').value
});


// Sync editor content to textarea before form submit
document.querySelector('#itemForm').addEventListener('submit', function() {
    document.querySelector('#description').value = editor.getMarkdown();
});

// Initialize tag token box
const itemDetailAllTags = JSON.parse(document.getElementById('item-detail-all-tags').textContent || '[]');
const itemDetailSelectedTags = JSON.parse(document.getElementById('item-detail-selected-tags').textContent || '[]');
initializeTagTokenBox('itemDetailTagTokenBox', {
    allTags: itemDetailAllTags,
    selectedTags: itemDetailSelectedTags,
    hiddenInputContainerId: 'itemDetailTagHiddenInputs',
    inputPlaceholder: 'Add a tag and press Enter'
});

// Helper function to show alerts
function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.role = 'alert';
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Helper function to get CSRF token
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Generate Title Button
document.querySelector('#generateTitleBtn').addEventListener('click', async function() {
    const btn = this;
    const spinner = btn.querySelector('.spinner-border');
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    
    try {
        const description = editor.getMarkdown();
        
        if (!description) {
            showAlert('Please provide a description before generating title', 'warning');
            return;
        }
        
        const response = await fetch('/api/items/{{ item.id }}/generate-title', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                description: description
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Update title field with generated title
            if (data.title) {
                document.querySelector('#title').value = data.title;
                showAlert('Title generated successfully!', 'success');
            }
        } else {
            showAlert(data.error || 'Failed to generate title', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
    }
});

// Extract Tags Button
document.querySelector('#extractTagsBtn').addEventListener('click', async function() {
    const btn = this;
    const spinner = btn.querySelector('.spinner-border');
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    
    try {
        const description = editor.getMarkdown();
        
        if (!description) {
            showAlert('Please provide a description before extracting tags', 'warning');
            return;
        }
        
        const response = await fetch('/api/items/{{ item.id }}/extract-tags', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                description: description
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Update tag token box with extracted tags
            if (data.tags && data.tags.length > 0) {
                const tagTokenBox = document.getElementById('itemDetailTagTokenBox');
                if (tagTokenBox) {
                    // Clear existing tags by removing all tag tokens
                    tagTokenBox.querySelectorAll('.tag-token').forEach(token => {
                        token.remove();
                    });
                    
                    // Re-initialize the tag token box with new tags
                    const allTags = JSON.parse(document.getElementById('item-detail-all-tags').textContent || '[]');
                    const newSelectedTags = data.tags.map(tagName => {
                        // Find tag in all tags or create new one
                        const existingTag = allTags.find(t => t.name === tagName);
                        return existingTag || { name: tagName, color: '#3b82f6', isNew: true };
                    });
                    
                    initializeTagTokenBox('itemDetailTagTokenBox', {
                        allTags: allTags,
                        selectedTags: newSelectedTags,
                        hiddenInputContainerId: 'itemDetailTagHiddenInputs',
                        inputPlaceholder: 'Add a tag and press Enter'
                    });
                }
                showAlert('Tags extracted successfully!', 'success');
            }
        } else {
            showAlert(data.error || 'Failed to extract tags', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
    }
});

// Optimize Description Button
document.querySelector('#optimizeDescriptionBtn').addEventListener('click', async function() {
    const btn = this;
    const spinner = btn.querySelector('.spinner-border');
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    
    try {
        const description = editor.getMarkdown();
        
        if (!description) {
            showAlert('Please provide a description before optimizing', 'warning');
            return;
        }
        
        const response = await fetch('/api/items/{{ item.id }}/optimize-description', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                description: description
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Update editor with optimized description
            if (data.description) {
                editor.setMarkdown(data.description);
                showAlert('Description optimized successfully!', 'success');
            }
        } else {
            showAlert(data.error || 'Failed to optimize description', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
    }
});

// AI Enhance Button
document.querySelector('#aiEnhanceBtn').addEventListener('click', async function() {
    const btn = this;
    btn.classList.add('loading');
    btn.disabled = true;
    
    try {
        const title = document.querySelector('#title').value;
        const description = editor.getMarkdown();
        
        if (!title || !description) {
            showAlert('Please provide both title and description before using AI Enhancer', 'warning');
            return;
        }
        
        const response = await fetch('/api/items/{{ item.id }}/ai-enhance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                title: title,
                description: description
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Update form with enhanced content
            if (data.title) {
                document.querySelector('#title').value = data.title;
            }
            if (data.description) {
                editor.setMarkdown(data.description);
            }
            showAlert('Content enhanced successfully! Review and save the changes.', 'success');
        } else {
            showAlert(data.error || 'Failed to enhance content', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
});

// Build Tasks Button
document.querySelector('#buildTasksBtn').addEventListener('click', async function() {
    const btn = this;
    btn.classList.add('loading');
    btn.disabled = true;
    
    try {
        const title = document.querySelector('#title').value;
        const description = editor.getMarkdown();
        
        if (!title || !description) {
            showAlert('Please provide both title and description before building tasks', 'warning');
            return;
        }
        
        const response = await fetch('/api/items/{{ item.id }}/build-tasks', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                title: title,
                description: description
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showAlert(`Successfully created ${data.count} task(s). Refreshing...`, 'success');
            // Reload page to show new tasks
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showAlert(data.error || 'Failed to build tasks', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
});

// Check Similarity Button
document.querySelector('#checkSimilarityBtn').addEventListener('click', async function() {
    const btn = this;
    btn.classList.add('loading');
    btn.disabled = true;
    
    try {
        const title = document.querySelector('#title').value;
        const description = editor.getMarkdown();
        
        if (!description) {
            showAlert('Please provide a description before checking similarity', 'warning');
            return;
        }
        
        const response = await fetch('/api/items/{{ item.id }}/check-similarity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                title: title,
                description: description
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            const similarItems = data.similar_items || [];
            const container = document.getElementById('similarItemsContainer');
            
            if (similarItems.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-diagram-3" style="font-size: 3rem;"></i>
                        <p class="mt-3">No similar items found</p>
                    </div>
                `;
            } else {
                let html = '<div class="list-group">';
                similarItems.forEach(item => {
                    // Convert distance to similarity percentage (lower distance = higher similarity)
                    const distance = item.distance || 0;
                    const similarity = Math.max(0, (1 - distance) * 100).toFixed(1);
                    const metadata = item.metadata || {};
                    const itemTitle = metadata.title || 'Untitled';
                    const itemDesc = item.document || metadata.description || '';
                    // Tags are stored as comma-separated string in ChromaDB metadata
                    const tagsString = metadata.tags || '';
                    const tags = tagsString ? tagsString.split(',').map(t => t.trim()).filter(t => t) : [];
                    
                    html += `
                        <a href="/items/${item.id}/" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${itemTitle}</h6>
                                <small class="text-muted">${similarity}% similar</small>
                            </div>
                            <p class="mb-1 text-muted small">${itemDesc.substring(0, 150)}${itemDesc.length > 150 ? '...' : ''}</p>
                            ${tags.length > 0 ? `<small><i class="bi bi-tags"></i> ${tags.join(', ')}</small>` : ''}
                        </a>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            }
            
            // Switch to similar items tab
            const similarTab = document.querySelector('#similar-tab');
            if (similarTab) {
                similarTab.click();
            }
            
            showAlert(`Found ${similarItems.length} similar item(s)`, 'success');
        } else {
            showAlert(data.error || 'Failed to check similarity', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.classList.remove('loading');
        btn.disabled = false;
    }
});

// Sync GitHub Issues Button
document.querySelector('#syncGitHubIssuesBtn')?.addEventListener('click', async function() {
    const btn = this;
    const spinner = btn.querySelector('.spinner-border');
    const buttonText = btn.querySelector('.button-text');
    
    // Show confirmation dialog
    const confirmed = confirm(
        'This will create tasks from all GitHub issues in the repository that are not already linked to this item.\n\n' +
        'Potential duplicates will be marked with "*** Duplikat? ***" prefix.\n\n' +
        'Do you want to continue?'
    );
    
    if (!confirmed) {
        return;
    }
    
    btn.disabled = true;
    spinner.style.display = 'inline-block';
    
    try {
        const response = await fetch('/api/github/sync-issues-to-tasks/{{ item.id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                state: 'all'  // Sync both open and closed issues
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            let message = `GitHub synchronization completed!\n\n`;
            message += `Issues checked: ${data.issues_checked}\n`;
            message += `Tasks created: ${data.tasks_created}\n`;
            message += `Duplicates by ID: ${data.duplicates_by_id}\n`;
            message += `Duplicates by title: ${data.duplicates_by_title}`;
            
            if (data.error_count && data.error_count > 0) {
                message += `\n\nSome issues encountered: ${data.error_count}`;
            }
            
            showAlert(message, 'success');
            
            // Reload the page to show new tasks
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(data.error || 'Failed to sync GitHub issues', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        spinner.style.display = 'none';
    }
});

// Send Email Button
document.querySelector('#confirmSendEmailBtn').addEventListener('click', async function() {
    const btn = this;
    const modal = bootstrap.Modal.getInstance(document.getElementById('sendEmailModal'));
    const emailInput = document.querySelector('#recipientEmail');
    const email = emailInput.value.trim();
    
    // Validate email
    if (!email) {
        showAlert('Please enter a recipient email address', 'warning');
        return;
    }
    
    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showAlert('Please enter a valid email address', 'warning');
        return;
    }
    
    // Disable button and show loading state
    btn.disabled = true;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    
    try {
        const response = await fetch('/api/items/{{ item.id }}/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                email: email
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            showAlert(`Email successfully sent to ${email}`, 'success');
            // Close modal
            modal.hide();
            // Clear email input
            emailInput.value = '';
        } else {
            showAlert(data.error || 'Failed to send email', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error: ' + error.message, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
});

// Show Completed Tasks Toggle
const showCompletedSwitch = document.getElementById('showCompletedSwitch');
if (showCompletedSwitch) {
    showCompletedSwitch.addEventListener('change', function() {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('show_completed', this.checked ? 'true' : 'false');
        // Reset to page 1 when toggling completed status
        currentUrl.searchParams.delete('page');
        window.location.href = currentUrl.toString();
    });
}

// Initialize Semantic Network Viewer
let semanticNetworkViewer;
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the semantic network viewer
    semanticNetworkViewer = new SemanticNetworkViewer('semanticNetworkContainer', {
        objectType: 'item',
        objectId: '{{ item.id }}',
        depth: 3,
        generateSummaries: true,
        onNodeClick: function(nodeData) {
            // Custom click handler - navigate to the clicked object
            const type = nodeData.type;
            const id = nodeData.id;
            
            if (type === 'item') {
                window.location.href = `/items/${id}/`;
            } else if (type === 'task') {
                window.location.href = `/tasks/${id}/`;
            }
        }
    });
    
    // Load the semantic network
    semanticNetworkViewer.load('item', '{{ item.id }}');
});

// File Upload Functionality - Now handled by htmx
// The JavaScript functions are kept for backward compatibility and toast notifications
(function() {
    // Re-show htmx indicator when htmx:beforeRequest event fires
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        // Check if this is a file upload or delete request
        const target = event.detail.target;
        if (target && target.id === 'filesListContainer') {
            const uploadProgress = document.getElementById('uploadProgress');
            if (uploadProgress) {
                uploadProgress.style.display = 'block';
            }
        }
    });
    
    // Hide htmx indicator and show alert when htmx:afterRequest event fires
    document.body.addEventListener('htmx:afterRequest', function(event) {
        const target = event.detail.target;
        if (target && target.id === 'filesListContainer') {
            const uploadProgress = document.getElementById('uploadProgress');
            if (uploadProgress) {
                uploadProgress.style.display = 'none';
            }
            
            // Show success/error alert
            if (event.detail.successful) {
                showAlert('Operation completed successfully', 'success');
            } else {
                showAlert('Operation failed', 'danger');
            }
        }
    });
    
    // Reset file input after upload
    document.body.addEventListener('htmx:afterOnLoad', function(event) {
        const fileInput = document.getElementById('fileInputHtmx');
        if (fileInput) {
            fileInput.value = ''; // Clear the file input
        }
    });
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
})();
</script>
{% endblock %}
