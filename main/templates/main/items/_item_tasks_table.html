{% if tasks %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Title</th>
                <th>Status</th>
                <th>GitHub</th>
                <th>Assigned To</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr id="task-row-{{ task.id }}">
                <td>
                    <a href="{% url 'main:task_detail' task.id %}" class="text-decoration-none">
                        {{ task.title }}
                    </a>
                </td>
                <td>
                    <select class="form-select form-select-sm task-status-select" 
                            data-task-id="{{ task.id }}" 
                            style="width: auto; min-width: 120px;"
                            onchange="updateTaskStatus('{{ task.id }}', this.value)">
                        <option value="new" {% if task.status == 'new' %}selected{% endif %}>âšª Neu</option>
                        <option value="working" {% if task.status == 'working' %}selected{% endif %}>ðŸ”µ Working</option>
                        <option value="review" {% if task.status == 'review' %}selected{% endif %}>ðŸŸ¡ Review</option>
                        <option value="ready" {% if task.status == 'ready' %}selected{% endif %}>ðŸŸ¢ Ready</option>
                        <option value="done" {% if task.status == 'done' %}selected{% endif %}>âœ… Erledigt</option>
                    </select>
                </td>
                <td>
                    {% if task.github_issue_id %}
                    <a href="{{ task.github_issue_url }}" target="_blank" class="text-decoration-none">
                        #{{ task.github_issue_id }} <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.assigned_to %}
                    {{ task.assigned_to.username }}
                    {% else %}
                    <span class="text-muted">Unassigned</span>
                    {% endif %}
                </td>
                <td>
                    <small class="text-muted">{{ task.created_at|date:"Y-m-d" }}</small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="{% url 'main:task_detail' task.id %}" class="btn btn-sm btn-outline-primary" title="View details">
                            <i class="bi bi-eye"></i>
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-danger" 
                                onclick="deleteTask('{{ task.id }}')" 
                                title="Delete task">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if tasks.paginator.num_pages > 1 %}
<nav aria-label="Tasks pagination" class="mt-3">
    <ul class="pagination justify-content-center">
        {% if tasks.has_previous %}
        <li class="page-item">
            <a class="page-link" 
               href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-get="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-target="#item-tasks-table-container"
               hx-swap="innerHTML"
               hx-indicator="#tasks-loading-indicator"
               aria-label="First">
                <span aria-hidden="true">&laquo;&laquo;</span>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" 
               href="?page={{ tasks.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-get="?page={{ tasks.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-target="#item-tasks-table-container"
               hx-swap="innerHTML"
               hx-indicator="#tasks-loading-indicator"
               aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&laquo;&laquo;</span>
        </li>
        <li class="page-item disabled">
            <span class="page-link">&laquo;</span>
        </li>
        {% endif %}
        
        {% for page_num in tasks.paginator.page_range %}
            {% if page_num == tasks.number %}
            <li class="page-item active" aria-current="page">
                <span class="page-link">{{ page_num }}</span>
            </li>
            {% elif page_num > tasks.number|add:'-3' and page_num < tasks.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" 
                   href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
                   hx-get="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
                   hx-target="#item-tasks-table-container"
                   hx-swap="innerHTML"
                   hx-indicator="#tasks-loading-indicator">{{ page_num }}</a>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if tasks.has_next %}
        <li class="page-item">
            <a class="page-link" 
               href="?page={{ tasks.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-get="?page={{ tasks.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-target="#item-tasks-table-container"
               hx-swap="innerHTML"
               hx-indicator="#tasks-loading-indicator"
               aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" 
               href="?page={{ tasks.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-get="?page={{ tasks.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if show_completed %}&show_completed=true{% endif %}"
               hx-target="#item-tasks-table-container"
               hx-swap="innerHTML"
               hx-indicator="#tasks-loading-indicator"
               aria-label="Last">
                <span aria-hidden="true">&raquo;&raquo;</span>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">&raquo;</span>
        </li>
        <li class="page-item disabled">
            <span class="page-link">&raquo;&raquo;</span>
        </li>
        {% endif %}
    </ul>
    <div class="text-center text-muted small">
        Seite {{ tasks.number }} von {{ tasks.paginator.num_pages }} ({{ tasks.paginator.count }} Task(s) gesamt)
    </div>
</nav>
{% endif %}

{% else %}
{% if search_query %}
<div class="text-center text-muted py-5">
    <i class="bi bi-search" style="font-size: 3rem;"></i>
    <p class="mt-3">Keine Tasks gefunden fÃ¼r "{{ search_query }}"</p>
    <a href="?{% if show_completed %}show_completed=true{% endif %}" class="btn btn-outline-secondary">
        Suche zurÃ¼cksetzen
    </a>
</div>
{% else %}
<div class="text-center text-muted py-5">
    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
    <p class="mt-3">No tasks yet. Use "Build Tasks" to generate tasks from this item.</p>
</div>
{% endif %}
{% endif %}

<script>
// Re-initialize Bootstrap tooltips after HTMX swap
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'item-tasks-table-container') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});

// Get CSRF token helper
function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Delete task function (no confirmation)
async function deleteTask(taskId) {
    try {
        const response = await fetch(`/api/tasks/${taskId}/quick-delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Remove the task row from the table with a fade effect
            const taskRow = document.getElementById(`task-row-${taskId}`);
            if (taskRow) {
                taskRow.style.transition = 'opacity 0.3s';
                taskRow.style.opacity = '0';
                setTimeout(() => {
                    // Refresh the task table to update pagination and count
                    htmx.ajax('GET', window.location.search || '?', {
                        target: '#item-tasks-table-container',
                        swap: 'innerHTML'
                    });
                }, 300);
            }
        } else {
            alert('Failed to delete task: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Error deleting task:', error);
        alert('Error deleting task: ' + error.message);
    }
}

// Update task status function
async function updateTaskStatus(taskId, newStatus) {
    try {
        const response = await fetch(`/api/tasks/${taskId}/quick-status-update`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            // Show a brief success indicator
            const select = document.querySelector(`select[data-task-id="${taskId}"]`);
            if (select) {
                const originalBg = select.style.backgroundColor;
                select.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    select.style.backgroundColor = originalBg;
                }, 500);
            }
            
            // If status changed to 'done' and we're not showing completed tasks, refresh the table
            const showCompleted = {{ show_completed|lower }};
            if (newStatus === 'done' && !showCompleted) {
                setTimeout(() => {
                    htmx.ajax('GET', window.location.search || '?', {
                        target: '#item-tasks-table-container',
                        swap: 'innerHTML'
                    });
                }, 600);
            }
        } else {
            alert('Failed to update task status: ' + (data.error || 'Unknown error'));
            // Revert the select to previous value
            const select = document.querySelector(`select[data-task-id="${taskId}"]`);
            if (select) {
                // Reload to get correct status
                location.reload();
            }
        }
    } catch (error) {
        console.error('Error updating task status:', error);
        alert('Error updating task status: ' + error.message);
    }
}
</script>
