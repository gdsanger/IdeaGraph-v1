{% extends "main/base.html" %}
{% load static %}

{% block title %}{{ milestone.name }} - Milestone Details{% endblock %}

{% block extra_css %}
<!-- Semantic Network CSS -->
<link rel="stylesheet" href="{% static 'main/css/semantic-network.css' %}" />
<!-- Weaviate Indicator CSS -->
<link rel="stylesheet" href="{% static 'main/css/weaviate-indicator.css' %}" />
<!-- Toast UI Editor/Viewer CSS -->
<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.css" />

<style>
    .milestone-detail-card {
        background: rgba(31, 41, 55, 0.9);
    }
    
    .context-object-card {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .context-object-card:hover {
        border-color: var(--autumn-accent);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
    }
    
    .context-type-icon {
        font-size: 2rem;
        display: inline-block;
        margin-right: 0.5rem;
    }
    
    .ai-button {
        position: relative;
    }
    
    .ai-button .spinner-border {
        display: none;
        width: 1rem;
        height: 1rem;
        margin-left: 0.5rem;
    }
    
    .ai-button.loading .spinner-border {
        display: inline-block;
    }
    
    .ai-button.loading .button-text {
        opacity: 0.7;
    }
    
    .file-upload-area {
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 0.5rem;
        padding: 2rem;
        text-align: center;
        background: rgba(15, 23, 42, 0.4);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .file-upload-area:hover {
        border-color: var(--autumn-accent);
        background: rgba(15, 23, 42, 0.6);
    }
    
    .file-upload-area.dragover {
        border-color: var(--autumn-accent);
        background: rgba(245, 158, 11, 0.1);
    }
    
    .upload-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(4px);
    }
    
    .upload-overlay-content {
        background: rgba(31, 41, 55, 0.95);
        padding: 2rem;
        border-radius: 1rem;
        border: 2px solid var(--autumn-accent);
        text-align: center;
        min-width: 400px;
        box-shadow: 0 10px 40px rgba(245, 158, 11, 0.3);
    }
    
    .upload-spinner {
        width: 4rem;
        height: 4rem;
        border: 4px solid rgba(245, 158, 11, 0.3);
        border-top-color: var(--autumn-accent);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1.5rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .upload-status {
        margin-top: 1rem;
        color: rgba(255, 255, 255, 0.8);
    }
    
    .file-progress-item {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        margin: 0.5rem 0;
        background: rgba(15, 23, 42, 0.6);
        border-radius: 0.25rem;
        border-left: 3px solid var(--autumn-accent);
    }
    
    .file-progress-item i {
        margin-right: 0.5rem;
        color: var(--autumn-accent);
    }
    
    .file-progress-item.success i {
        color: #10b981;
    }
    
    .file-progress-item.error i {
        color: #ef4444;
    }
    
    /* Changelog viewer styling */
    #changelogViewer {
        background-color: #1f2937;
        padding: 1rem;
        border-radius: 0.5rem;
        color: #e5e7eb;
    }
    
    #changelogViewer h1,
    #changelogViewer h2,
    #changelogViewer h3,
    #changelogViewer h4,
    #changelogViewer h5,
    #changelogViewer h6 {
        color: var(--autumn-accent);
        margin-top: 1rem;
        margin-bottom: 0.5rem;
    }
    
    #changelogViewer ul,
    #changelogViewer ol {
        padding-left: 2rem;
    }
    
    #changelogViewer code {
        background-color: rgba(15, 23, 42, 0.8);
        padding: 0.2rem 0.4rem;
        border-radius: 0.25rem;
        color: #fbbf24;
    }
    
    #changelogViewer pre {
        background-color: rgba(15, 23, 42, 0.8);
        padding: 1rem;
        border-radius: 0.5rem;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'main:item_list' %}">Items</a></li>
            <li class="breadcrumb-item"><a href="{% url 'main:item_detail' milestone.item.id %}">{{ milestone.item.title }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ milestone.name }}</li>
        </ol>
    </nav>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Milestone Header -->
    <div class="card milestone-detail-card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2 class="mb-2">
                        <i class="bi bi-flag-fill text-warning"></i>
                        {{ milestone.name }}
                    </h2>
                    <div class="mb-3">
                        <span class="badge 
                            {% if milestone.status == 'planned' %}bg-secondary
                            {% elif milestone.status == 'in_progress' %}bg-primary
                            {% elif milestone.status == 'completed' %}bg-success
                            {% endif %} me-2">
                            {{ milestone.get_status_display }}
                        </span>
                        <span class="text-muted">
                            <i class="bi bi-calendar"></i> {{ milestone.due_date|date:"d.m.Y" }}
                            {% if milestone.due_date < today %}
                                <span class="badge bg-danger ms-1">Überfällig</span>
                            {% elif milestone.due_date <= week_from_today %}
                                <span class="badge bg-warning ms-1">Bald fällig</span>
                            {% endif %}
                        </span>
                    </div>
                    {% if milestone.description %}
                    <p class="text-muted mb-0">{{ milestone.description }}</p>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-3">
                    <!-- Weaviate Indicator -->
                    <div class="weaviate-indicator-container">
                        <span class="weaviate-indicator-label">Weaviate:</span>
                        <div data-weaviate-indicator data-weaviate-type="milestone" data-weaviate-id="{{ milestone.id }}"></div>
                    </div>
                    <div class="btn-group" role="group">
                        <a href="{% url 'main:milestone_edit' milestone.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        <a href="{% url 'main:milestone_delete' milestone.id %}" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-4" id="milestoneTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab" data-bs-target="#summary" 
                    type="button" role="tab" aria-controls="summary" aria-selected="true">
                <i class="bi bi-file-text"></i> Summary
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="changelog-tab" data-bs-toggle="tab" data-bs-target="#changelog" 
                    type="button" role="tab" aria-controls="changelog" aria-selected="false">
                <i class="bi bi-journal-text"></i> ChangeLog
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" 
                    type="button" role="tab" aria-controls="tasks" aria-selected="false">
                <i class="bi bi-list-task"></i> Tasks ({{ milestone.tasks.count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="context-tab" data-bs-toggle="tab" data-bs-target="#context" 
                    type="button" role="tab" aria-controls="context" aria-selected="false">
                <i class="bi bi-collection"></i> Context ({{ milestone.context_objects.count }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="semantic-network-tab" data-bs-toggle="tab" data-bs-target="#semantic-network" 
                    type="button" role="tab" aria-controls="semantic-network" aria-selected="false">
                <i class="bi bi-diagram-3"></i> Semantic Network
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="milestoneTabsContent">
        <!-- Summary Tab -->
        <div class="tab-pane fade show active" id="summary" role="tabpanel" aria-labelledby="summary-tab">
            <div class="card milestone-detail-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-robot"></i> AI-Generated Summary</h4>
                        <div>
                            <button class="btn btn-primary ai-button" id="regenerateSummaryBtn">
                                <span class="button-text">
                                    <i class="bi bi-arrow-clockwise"></i> Regenerate Summary
                                </span>
                                <span class="spinner-border" role="status" aria-hidden="true"></span>
                            </button>
                            {% if milestone.summary %}
                            <button class="btn btn-success ai-button ms-2" id="optimizeSummaryBtn">
                                <span class="button-text">
                                    <i class="bi bi-magic"></i> AI-Optimize
                                </span>
                                <span class="spinner-border" role="status" aria-hidden="true"></span>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div id="summaryContent">
                        {% if milestone.summary %}
                        <div class="alert alert-info">
                            {{ milestone.summary }}
                        </div>
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-info-circle"></i>
                            No summary generated yet. Add context objects and click "Regenerate Summary" to create one.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Statistics -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card bg-dark">
                                <div class="card-body text-center">
                                    <h3 class="text-primary">{{ milestone.context_objects.count }}</h3>
                                    <p class="text-muted mb-0">Context Objects</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark">
                                <div class="card-body text-center">
                                    <h3 class="text-success">{{ milestone.tasks.count }}</h3>
                                    <p class="text-muted mb-0">Total Tasks</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-dark">
                                <div class="card-body text-center">
                                    <h3 class="text-warning">{{ analyzed_count }}</h3>
                                    <p class="text-muted mb-0">Analyzed Objects</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ChangeLog Tab -->
        <div class="tab-pane fade" id="changelog" role="tabpanel" aria-labelledby="changelog-tab">
            <div class="card milestone-detail-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-journal-text"></i> ChangeLog</h4>
                        <button class="btn btn-primary ai-button" id="generateChangelogBtn">
                            <span class="button-text">
                                {% if milestone.changelog %}
                                <i class="bi bi-arrow-clockwise"></i> Recreate ChangeLog
                                {% else %}
                                <i class="bi bi-robot"></i> Generate ChangeLog
                                {% endif %}
                            </span>
                            <span class="spinner-border" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                    
                    <div id="changelogContent">
                        {% if milestone.changelog %}
                        <div class="card bg-dark">
                            <div class="card-body">
                                <div id="changelogViewer"></div>
                                <textarea id="changelogMarkdown" style="display: none;">{{ milestone.changelog }}</textarea>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-info-circle"></i>
                            No changelog generated yet. Click "Generate ChangeLog" to create one using AI. 
                            You can recreate it at any time to update the changelog based on current completed tasks.
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Files Section -->
                    {% if milestone.files.all %}
                    <div class="mt-4">
                        <h5><i class="bi bi-file-earmark-text"></i> Changelog Files</h5>
                        <div class="list-group">
                            {% for file in milestone.files.all %}
                            <div class="list-group-item list-group-item-dark d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-file-earmark-text"></i>
                                    {{ file.filename }}
                                    <small class="text-muted">({{ file.file_size|filesizeformat }})</small>
                                </div>
                                <div>
                                    {% if file.weaviate_synced %}
                                    <span class="badge bg-success" title="Synced to Weaviate">
                                        <i class="bi bi-check-circle"></i> Synced
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning" title="Not synced to Weaviate">
                                        <i class="bi bi-exclamation-circle"></i> Not Synced
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Tasks Tab -->
        <div class="tab-pane fade" id="tasks" role="tabpanel" aria-labelledby="tasks-tab">
            <div class="card milestone-detail-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-list-task"></i> Tasks</h4>
                        <a href="{% url 'main:task_create' milestone.item.id %}?milestone={{ milestone.id }}" 
                           class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> New Task
                        </a>
                    </div>
                    
                    {% if milestone.tasks.all %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Status</th>
                                    <th>Type</th>
                                    <th>AI Generated</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in milestone.tasks.all %}
                                <tr>
                                    <td>
                                        <a href="{% url 'main:task_detail' task.id %}">{{ task.title }}</a>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if task.status == 'new' %}bg-secondary
                                            {% elif task.status == 'working' %}bg-primary
                                            {% elif task.status == 'review' %}bg-warning
                                            {% elif task.status == 'ready' %}bg-info
                                            {% elif task.status == 'done' %}bg-success
                                            {% endif %}">
                                            {{ task.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-dark">{{ task.get_type_display }}</span>
                                    </td>
                                    <td>
                                        {% if task.ai_generated %}
                                        <i class="bi bi-robot text-success"></i>
                                        {% else %}
                                        <i class="bi bi-person text-muted"></i>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'main:task_detail' task.id %}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-secondary">
                        <i class="bi bi-info-circle"></i>
                        No tasks assigned to this milestone yet. Create tasks manually or derive them from context objects.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Context Tab -->
        <div class="tab-pane fade" id="context" role="tabpanel" aria-labelledby="context-tab">
            <div class="card milestone-detail-card">
                <div class="card-body">
                    <h4 class="mb-3"><i class="bi bi-collection"></i> Context Objects</h4>
                    
                    <!-- Add Context Object Section -->
                    <div class="mb-4">
                        <button class="btn btn-primary mb-3" data-bs-toggle="collapse" data-bs-target="#addContextForm">
                            <i class="bi bi-plus-circle"></i> Add Context Object
                        </button>
                        
                        <div class="collapse" id="addContextForm">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <form id="contextObjectForm">
                                        {% csrf_token %}
                                        
                                        <ul class="nav nav-pills mb-3" id="contextTypeTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="file-tab-btn" data-bs-toggle="pill" 
                                                        data-bs-target="#file-upload" type="button" role="tab">
                                                    📄 File
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="text-tab-btn" data-bs-toggle="pill" 
                                                        data-bs-target="#text-input" type="button" role="tab">
                                                    📝 Note / Transcript / Email
                                                </button>
                                            </li>
                                        </ul>
                                        
                                        <div class="tab-content" id="contextTypeContent">
                                            <!-- File Upload -->
                                            <div class="tab-pane fade show active" id="file-upload" role="tabpanel">
                                                <div class="file-upload-area" id="fileUploadArea">
                                                    <input type="file" id="fileInput" class="d-none" multiple 
                                                           accept=".txt,.pdf,.docx,.md">
                                                    <i class="bi bi-cloud-upload" style="font-size: 3rem;"></i>
                                                    <p class="mb-0">Click to select files or drag and drop</p>
                                                    <small class="text-muted">Supported: .txt, .pdf, .docx, .md</small>
                                                </div>
                                                <div id="fileList" class="mt-3"></div>
                                            </div>
                                            
                                            <!-- Unified Text Input -->
                                            <div class="tab-pane fade" id="text-input" role="tabpanel">
                                                <div class="mb-3">
                                                    <label for="textObjectType" class="form-label">Type</label>
                                                    <select class="form-select" id="textObjectType">
                                                        <option value="note">🗒️ Note</option>
                                                        <option value="transcript">🎙️ Transcript</option>
                                                        <option value="email">✉️ Email</option>
                                                    </select>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="textObjectTitle" class="form-label">Title / Subject</label>
                                                    <input type="text" class="form-control" id="textObjectTitle" 
                                                           placeholder="Enter title or subject">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="textObjectContent" class="form-label">Content</label>
                                                    <textarea class="form-control" id="textObjectContent" rows="8" 
                                                              placeholder="Enter content here"></textarea>
                                                </div>
                                                <button type="button" class="btn btn-primary" id="addTextObjectBtn">
                                                    <i class="bi bi-save"></i> Add Context Object
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Context Objects List -->
                    <div id="contextObjectsList">
                        {% if milestone.context_objects.all %}
                            {% for context in milestone.context_objects.all %}
                            <div class="context-object-card" data-context-id="{{ context.id }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <span class="context-type-icon">
                                                {% if context.type == 'file' %}
                                                    {# File type icons #}
                                                    {% if context.title|lower|slice:"-4:" == ".pdf" %}
                                                        <i class="bi bi-file-pdf-fill text-danger"></i>
                                                    {% elif context.title|lower|slice:"-5:" == ".docx" or context.title|lower|slice:"-4:" == ".doc" %}
                                                        <i class="bi bi-file-word-fill text-primary"></i>
                                                    {% elif context.title|lower|slice:"-4:" == ".eml" or context.title|lower|slice:"-4:" == ".msg" %}
                                                        <i class="bi bi-envelope-fill text-warning"></i>
                                                    {% elif context.title|lower|slice:"-5:" == ".html" or context.title|lower|slice:"-4:" == ".htm" %}
                                                        <i class="bi bi-file-code-fill text-success"></i>
                                                    {% elif context.title|lower|slice:"-4:" == ".txt" %}
                                                        <i class="bi bi-file-text-fill text-info"></i>
                                                    {% elif context.title|lower|slice:"-3:" == ".md" %}
                                                        <i class="bi bi-markdown-fill text-info"></i>
                                                    {% else %}
                                                        <i class="bi bi-file-earmark-fill text-secondary"></i>
                                                    {% endif %}
                                                {% elif context.type == 'email' %}✉️
                                                {% elif context.type == 'transcript' %}🎙️
                                                {% elif context.type == 'note' %}🗒️
                                                {% endif %}
                                            </span>
                                            <div>
                                                <h5 class="mb-0">{{ context.title }}</h5>
                                                <small class="text-muted">
                                                    {{ context.get_type_display }} • {{ context.created_at|date:"d.m.Y H:i" }}
                                                    {% if context.uploaded_by %}
                                                    • by {{ context.uploaded_by.username }}
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                        
                                        {% if context.analyzed %}
                                        <span class="badge bg-success mb-2">
                                            <i class="bi bi-check-circle"></i> Analyzed
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary mb-2">
                                            <i class="bi bi-clock"></i> Not Analyzed
                                        </span>
                                        {% endif %}
                                        
                                        {% if context.summary %}
                                        <div class="mb-2">
                                            <strong>Summary:</strong>
                                            <p class="text-muted mb-0">{{ context.summary }}</p>
                                        </div>
                                        {% endif %}
                                        
                                        {% if context.derived_tasks %}
                                        <div class="mb-2">
                                            <span class="badge bg-warning">
                                                <i class="bi bi-list-task"></i> {{ context.derived_tasks|length }} task(s) derived
                                            </span>
                                        </div>
                                        {% endif %}
                                        
                                        {% if context.url %}
                                        <div class="mb-2">
                                            <a href="{{ context.url }}" target="_blank" class="text-info">
                                                <i class="bi bi-link-45deg"></i> View Source
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="btn-group-vertical" role="group">
                                        {% if context.type == 'file' and context.source_id %}
                                        <a href="{% url 'main:api_milestone_context_download' context.id %}" 
                                           class="btn btn-sm btn-outline-info" 
                                           title="Download file" 
                                           target="_blank">
                                            <i class="bi bi-download"></i> Download
                                        </a>
                                        {% endif %}
                                        {% if not context.analyzed %}
                                        <button class="btn btn-sm btn-outline-primary analyze-context-btn" 
                                                data-context-id="{{ context.id }}" title="Analyze with AI">
                                            <i class="bi bi-robot"></i> Analyze
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-info show-results-btn" 
                                                data-context-id="{{ context.id }}" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#resultsModal"
                                                title="View analysis results">
                                            <i class="bi bi-eye"></i> Show Results
                                        </button>
                                        {% endif %}
                                        {% if context.analyzed and context.derived_tasks %}
                                        <button class="btn btn-sm btn-outline-success accept-results-btn" 
                                                data-context-id="{{ context.id }}" 
                                                title="Accept and apply results">
                                            <i class="bi bi-check-circle"></i> Accept
                                        </button>
                                        {% endif %}
                                        {% if context.derived_tasks %}
                                        <button class="btn btn-sm btn-outline-success create-tasks-btn" 
                                                data-context-id="{{ context.id }}" title="Create tasks from analysis">
                                            <i class="bi bi-plus-circle"></i> Create Tasks
                                        </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-outline-danger delete-context-btn" 
                                                data-context-id="{{ context.id }}" title="Delete">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="alert alert-secondary">
                            <i class="bi bi-info-circle"></i>
                            No context objects yet. Click "Add Context Object" to add files, notes, transcripts, or emails.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Semantic Network Tab -->
        <div class="tab-pane fade" id="semantic-network" role="tabpanel" aria-labelledby="semantic-network-tab">
            <div class="card milestone-detail-card">
                <div class="card-body">
                    <div id="milestoneSemanticNetworkContainer"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Optimization Modal -->
<div class="modal fade" id="summaryOptimizationModal" tabindex="-1" aria-labelledby="summaryOptimizationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="summaryOptimizationModalLabel">
                    <i class="bi bi-magic"></i> AI Summary Optimization
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="optimizationLoading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-muted">Optimizing summary with AI...</p>
                </div>
                
                <!-- Comparison View -->
                <div id="optimizationComparison" style="display: none;">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> 
                        Review the AI-optimized version below. You can accept it or discard it and keep your current summary.
                    </div>
                    
                    <div class="row">
                        <!-- Original Summary -->
                        <div class="col-md-6">
                            <div class="card bg-secondary mb-3">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-file-text"></i> Original Summary</h6>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="originalSummaryText" class="text-muted"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Optimized Summary -->
                        <div class="col-md-6">
                            <div class="card bg-success bg-opacity-10 border-success mb-3">
                                <div class="card-header bg-success bg-opacity-25">
                                    <h6 class="mb-0"><i class="bi bi-stars"></i> AI-Optimized Summary</h6>
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="optimizedSummaryText"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Error State -->
                <div id="optimizationError" class="alert alert-danger" style="display: none;">
                    <i class="bi bi-exclamation-triangle"></i> 
                    <span id="optimizationErrorMessage"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Discard
                </button>
                <button type="button" class="btn btn-success" id="acceptOptimizedBtn" style="display: none;">
                    <i class="bi bi-check-circle"></i> Accept & Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Analysis Results Modal -->
<div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content bg-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="resultsModalLabel">
                    <i class="bi bi-robot"></i> AI Analysis Results
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="modalContextTitle" class="mb-3">
                    <h6 class="text-muted">Context Object:</h6>
                    <h5 id="modalContextTitleText"></h5>
                </div>
                
                <!-- Summary Section -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6><i class="bi bi-file-text"></i> Summary</h6>
                        <button class="btn btn-sm btn-outline-primary" id="enhanceSummaryBtn">
                            <i class="bi bi-magic"></i> Enhance Summary
                        </button>
                    </div>
                    <textarea class="form-control" id="modalSummaryText" rows="6" 
                              placeholder="AI-generated summary will appear here"></textarea>
                    <small class="text-muted">You can edit the summary before accepting.</small>
                </div>
                
                <!-- Derived Tasks Section -->
                <div class="mb-4">
                    <h6><i class="bi bi-list-task"></i> Derived Tasks</h6>
                    <div id="modalTasksList" class="list-group mb-2">
                        <!-- Tasks will be dynamically loaded here -->
                    </div>
                    <button class="btn btn-sm btn-outline-secondary" id="addTaskBtn">
                        <i class="bi bi-plus"></i> Add Task
                    </button>
                </div>
                
                <!-- Statistics -->
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    When you accept these results:
                    <ul class="mb-0 mt-2">
                        <li>The summary will be added to the milestone with source reference</li>
                        <li>Tasks can be created from the derived task list</li>
                        <li>The context object will be marked as accepted</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="acceptResultsBtn">
                    <i class="bi bi-check-circle"></i> Accept & Apply
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Toast UI Viewer JS -->
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.js"></script>

<!-- Sigma.js and dependencies for semantic network -->
<script src="https://cdn.jsdelivr.net/npm/graphology@0.25.4/dist/graphology.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/graphology-layout-forceatlas2@0.10.1/dist/graphology-layout-forceatlas2.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sigma@3.0.0-beta.20/build/sigma.min.js"></script>
<script src="{% static 'main/js/semantic-network.js' %}"></script>
<!-- Weaviate Indicator JavaScript -->
<script src="{% static 'main/js/weaviate-indicator.js' %}"></script>

<script>
// CSRF token for AJAX requests
const csrfToken = '{{ csrf_token }}';
const milestoneId = '{{ milestone.id }}';

// Cookie helper functions
function setCookie(name, value, days = 365) {
    const expires = new Date();
    expires.setTime(expires.getTime() + days * 24 * 60 * 60 * 1000);
    document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + expires.toUTCString() + ';path=/';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Tab state management
const TAB_COOKIE_NAME = 'milestone_active_tab';

// Save tab state when tab is clicked
document.querySelectorAll('#milestoneTabs button[data-bs-toggle="tab"]').forEach(tabButton => {
    tabButton.addEventListener('shown.bs.tab', function(event) {
        const tabId = event.target.getAttribute('data-bs-target');
        setCookie(TAB_COOKIE_NAME, tabId);
    });
});

// Restore last active tab on page load
document.addEventListener('DOMContentLoaded', function() {
    const lastActiveTab = getCookie(TAB_COOKIE_NAME);
    if (lastActiveTab) {
        const tabButton = document.querySelector(`#milestoneTabs button[data-bs-target="${lastActiveTab}"]`);
        if (tabButton) {
            const tab = new bootstrap.Tab(tabButton);
            tab.show();
        }
    }
});

// Toast notification utility
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Map type to Bootstrap classes
    const typeClass = {
        'success': 'text-bg-success',
        'error': 'text-bg-danger',
        'danger': 'text-bg-danger',
        'warning': 'text-bg-warning',
        'info': 'text-bg-info'
    }[type] || 'text-bg-info';
    
    // Create toast element
    const toastEl = document.createElement('div');
    toastEl.className = `toast align-items-center ${typeClass} border-0`;
    toastEl.setAttribute('role', 'alert');
    toastEl.setAttribute('aria-live', 'assertive');
    toastEl.setAttribute('aria-atomic', 'true');
    toastEl.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // Add to container
    toastContainer.appendChild(toastEl);
    
    // Initialize and show toast
    const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
    toast.show();
    
    // Remove from DOM after hidden
    toastEl.addEventListener('hidden.bs.toast', () => {
        toastEl.remove();
    });
}

// File upload handling
document.getElementById('fileUploadArea')?.addEventListener('click', function() {
    document.getElementById('fileInput').click();
});

document.getElementById('fileInput')?.addEventListener('change', function(e) {
    handleFiles(e.target.files);
});

// Drag and drop
const uploadArea = document.getElementById('fileUploadArea');
uploadArea?.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadArea?.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadArea?.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});

function handleFiles(files) {
    const fileList = document.getElementById('fileList');
    fileList.innerHTML = '';
    
    // Show upload overlay
    showUploadOverlay(files.length);
    
    let uploadPromises = [];
    
    Array.from(files).forEach(file => {
        uploadPromises.push(uploadFile(file));
    });
    
    Promise.all(uploadPromises)
        .then(() => {
            hideUploadOverlay();
            showToast('All files uploaded successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        })
        .catch(error => {
            hideUploadOverlay();
            showToast('Some files failed to upload: ' + error, 'error');
            setTimeout(() => location.reload(), 1500);
        });
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('auto_analyze', 'true');
    
    // Update overlay with current file
    updateUploadOverlay(file.name, 'uploading');
    
    return fetch(`/api/milestones/${milestoneId}/context/add`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            updateUploadOverlay(file.name, 'error');
            throw new Error(data.error || 'Upload failed');
        }
        // Show analyzing status briefly
        updateUploadOverlay(file.name, 'analyzing');
        // Then mark as success
        setTimeout(() => updateUploadOverlay(file.name, 'success'), 500);
        return data;
    })
    .catch(error => {
        updateUploadOverlay(file.name, 'error');
        throw error;
    });
}

// Show upload overlay
let uploadOverlay = null;
let uploadFileCount = 0;
let uploadCompletedCount = 0;

function showUploadOverlay(fileCount) {
    uploadFileCount = fileCount;
    uploadCompletedCount = 0;
    
    // Create overlay element
    const overlay = document.createElement('div');
    overlay.className = 'upload-overlay';
    overlay.innerHTML = `
        <div class="upload-overlay-content">
            <div class="upload-spinner"></div>
            <h4 class="text-white mb-3">
                <i class="bi bi-cloud-upload"></i> Uploading and Analyzing Files
            </h4>
            <div id="uploadProgressText" class="text-muted mb-3">
                Preparing upload...
            </div>
            <div id="uploadFileList" class="text-start" style="max-height: 300px; overflow-y: auto;">
                <!-- File progress items will be added here -->
            </div>
            <div class="upload-status mt-3">
                <span id="uploadCounter">0 / ${fileCount}</span> files processed
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    uploadOverlay = overlay;
}

function updateUploadOverlay(fileName, status) {
    if (!uploadOverlay) return;
    
    const fileList = uploadOverlay.querySelector('#uploadFileList');
    const progressText = uploadOverlay.querySelector('#uploadProgressText');
    const counter = uploadOverlay.querySelector('#uploadCounter');
    
    // Update or add file status
    let fileItem = fileList.querySelector(`[data-file="${fileName}"]`);
    if (!fileItem) {
        fileItem = document.createElement('div');
        fileItem.className = 'file-progress-item';
        fileItem.setAttribute('data-file', fileName);
        fileList.appendChild(fileItem);
    }
    
    // Update icon and text based on status
    if (status === 'uploading') {
        fileItem.innerHTML = `
            <i class="bi bi-arrow-up-circle"></i>
            <span>${fileName}</span>
        `;
        progressText.textContent = 'Uploading file...';
    } else if (status === 'analyzing') {
        fileItem.innerHTML = `
            <i class="bi bi-robot"></i>
            <span>${fileName}</span>
        `;
        fileItem.classList.add('analyzing');
        progressText.textContent = 'AI analyzing content...';
    } else if (status === 'success') {
        uploadCompletedCount++;
        fileItem.innerHTML = `
            <i class="bi bi-check-circle-fill"></i>
            <span>${fileName}</span>
        `;
        fileItem.classList.add('success');
        counter.textContent = `${uploadCompletedCount} / ${uploadFileCount}`;
        progressText.textContent = uploadCompletedCount === uploadFileCount 
            ? 'All files processed successfully!' 
            : 'Processing next file...';
    } else if (status === 'error') {
        uploadCompletedCount++;
        fileItem.innerHTML = `
            <i class="bi bi-x-circle-fill"></i>
            <span>${fileName} - Failed</span>
        `;
        fileItem.classList.add('error');
        counter.textContent = `${uploadCompletedCount} / ${uploadFileCount}`;
    }
}

function hideUploadOverlay() {
    if (uploadOverlay) {
        uploadOverlay.remove();
        uploadOverlay = null;
    }
}

// Add unified text object (Note, Transcript, Email)
document.getElementById('addTextObjectBtn')?.addEventListener('click', function() {
    const type = document.getElementById('textObjectType').value;
    const title = document.getElementById('textObjectTitle').value.trim();
    const content = document.getElementById('textObjectContent').value.trim();
    
    if (!title || !content) {
        showToast('Please provide both title and content.', 'warning');
        return;
    }
    
    uploadContextObject(type, title, content, '', '');
});

// Upload context object via API
function uploadContextObject(type, title, content, sourceId, url) {
    const btn = event?.target;
    if (btn) setLoading(btn, true);
    
    // Show simple loading overlay for text upload
    showUploadOverlay(1);
    updateUploadOverlay(title, 'uploading');
    
    fetch(`/api/milestones/${milestoneId}/context/add`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            type: type,
            title: title,
            content: content,
            source_id: sourceId,
            url: url,
            auto_analyze: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateUploadOverlay(title, 'success');
            showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} added successfully!`, 'success');
            setTimeout(() => {
                hideUploadOverlay();
                location.reload();
            }, 1000);
        } else {
            updateUploadOverlay(title, 'error');
            hideUploadOverlay();
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        updateUploadOverlay(title, 'error');
        setTimeout(() => hideUploadOverlay(), 1000);
        showToast('Error uploading context object: ' + error, 'error');
    })
    .finally(() => {
        if (btn) setLoading(btn, false);
    });
}

// Analyze context object
document.querySelectorAll('.analyze-context-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const contextId = this.dataset.contextId;
        analyzeContext(contextId, this);
    });
});

function analyzeContext(contextId, btn) {
    setLoading(btn, true);
    
    fetch(`/api/milestones/context/${contextId}/analyze`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Analysis complete! ' + data.task_count + ' tasks derived.', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error analyzing context: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
}

// Create tasks from derived tasks
document.querySelectorAll('.create-tasks-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const contextId = this.dataset.contextId;
        createTasks(contextId, this);
    });
});

function createTasks(contextId, btn) {
    setLoading(btn, true);
    
    fetch(`/api/milestones/context/${contextId}/create-tasks`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast(data.tasks_created + ' task(s) created successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error creating tasks: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
}

// Delete context object
document.querySelectorAll('.delete-context-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (!confirm('Are you sure you want to delete this context object?')) {
            return;
        }
        
        const contextId = this.dataset.contextId;
        deleteContext(contextId, this);
    });
});

function deleteContext(contextId, btn) {
    setLoading(btn, true);
    
    fetch(`/api/milestones/context/${contextId}/remove`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Context object deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error deleting context: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
}

// Generate ChangeLog with AI
document.getElementById('generateChangelogBtn')?.addEventListener('click', function() {
    // Check if there's an existing changelog
    const hasExistingChangelog = {{ milestone.changelog|yesno:'true,false' }};
    
    if (hasExistingChangelog) {
        // Show confirmation dialog for recreation
        const confirmMessage = 'This will replace the existing ChangeLog and all associated files. ' +
                              'The old ChangeLog will be permanently deleted. Do you want to continue?';
        if (!confirm(confirmMessage)) {
            return;
        }
    }
    
    generateChangelog(this);
});

function generateChangelog(btn) {
    setLoading(btn, true);
    
    fetch(`/api/milestones/${milestoneId}/generate-changelog`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('ChangeLog generated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error generating changelog: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
}

// Regenerate milestone summary
document.getElementById('regenerateSummaryBtn')?.addEventListener('click', function() {
    regenerateSummary(this);
});

function regenerateSummary(btn) {
    setLoading(btn, true);
    
    fetch(`/api/milestones/${milestoneId}/context/summarize`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Summary regenerated successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error regenerating summary: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
}

// AI Summary Optimization
let currentOptimizedSummary = null;
let currentOptimizationMeta = null;

document.getElementById('optimizeSummaryBtn')?.addEventListener('click', function() {
    optimizeSummary(this);
});

function optimizeSummary(btn) {
    setLoading(btn, true);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('summaryOptimizationModal'));
    modal.show();
    
    // Show loading state
    document.getElementById('optimizationLoading').style.display = 'block';
    document.getElementById('optimizationComparison').style.display = 'none';
    document.getElementById('optimizationError').style.display = 'none';
    document.getElementById('acceptOptimizedBtn').style.display = 'none';
    
    fetch(`/api/milestones/${milestoneId}/optimize-summary`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Store optimized summary
            currentOptimizedSummary = data.optimized_summary;
            currentOptimizationMeta = {
                agent_name: data.agent_name,
                model: data.model
            };
            
            // Show comparison
            document.getElementById('originalSummaryText').textContent = data.original_summary;
            document.getElementById('optimizedSummaryText').textContent = data.optimized_summary;
            
            document.getElementById('optimizationLoading').style.display = 'none';
            document.getElementById('optimizationComparison').style.display = 'block';
            document.getElementById('acceptOptimizedBtn').style.display = 'inline-block';
            
            showToast('Summary optimized successfully! Review the result.', 'success');
        } else {
            throw new Error(data.error || 'Optimization failed');
        }
    })
    .catch(error => {
        document.getElementById('optimizationLoading').style.display = 'none';
        document.getElementById('optimizationError').style.display = 'block';
        document.getElementById('optimizationErrorMessage').textContent = error.message || error;
        showToast('Error: ' + error.message, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
}

// Show results modal
let currentContextData = null;
document.querySelectorAll('.show-results-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const contextId = this.dataset.contextId;
        loadContextResults(contextId);
    });
});

function loadContextResults(contextId) {
    // Find context object data from the page
    const contextCard = document.querySelector(`[data-context-id="${contextId}"]`);
    if (!contextCard) return;
    
    const contextTitle = contextCard.querySelector('h5').textContent;
    
    // Load from API
    fetch(`/api/milestones/context/${contextId}/analyze`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success || data.context) {
            const context = data.context || data;
            currentContextData = {
                id: contextId,
                title: contextTitle,
                summary: context.summary || '',
                derived_tasks: context.derived_tasks || []
            };
            
            displayResultsInModal(currentContextData);
        } else {
            showToast('Error loading results: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error loading results: ' + error, 'error');
    });
}

function displayResultsInModal(contextData) {
    // Set title
    document.getElementById('modalContextTitleText').textContent = contextData.title;
    
    // Set summary
    document.getElementById('modalSummaryText').value = contextData.summary;
    
    // Display derived tasks
    const tasksList = document.getElementById('modalTasksList');
    tasksList.innerHTML = '';
    
    if (contextData.derived_tasks && contextData.derived_tasks.length > 0) {
        contextData.derived_tasks.forEach((task, index) => {
            const taskTitle = task.Titel || task.titel || task.title || '';
            const taskDesc = task.Beschreibung || task.beschreibung || task.description || '';
            
            const taskItem = document.createElement('div');
            taskItem.className = 'list-group-item bg-dark border-secondary';
            taskItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1 me-2">
                        <input type="text" class="form-control form-control-sm mb-1 task-title-input" 
                               value="${escapeHtml(taskTitle)}" placeholder="Task title" data-task-index="${index}">
                        <textarea class="form-control form-control-sm task-desc-input" 
                                  rows="2" placeholder="Task description" data-task-index="${index}">${escapeHtml(taskDesc)}</textarea>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-task-btn" data-task-index="${index}">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            `;
            tasksList.appendChild(taskItem);
        });
        
        // Add event listeners for remove buttons
        tasksList.querySelectorAll('.remove-task-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.dataset.taskIndex);
                removeTaskFromModal(index);
            });
        });
    } else {
        tasksList.innerHTML = '<div class="alert alert-secondary">No tasks derived yet.</div>';
    }
}

function removeTaskFromModal(index) {
    if (currentContextData && currentContextData.derived_tasks) {
        currentContextData.derived_tasks.splice(index, 1);
        displayResultsInModal(currentContextData);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Add new task button
document.getElementById('addTaskBtn')?.addEventListener('click', function() {
    if (!currentContextData) return;
    
    if (!currentContextData.derived_tasks) {
        currentContextData.derived_tasks = [];
    }
    
    currentContextData.derived_tasks.push({
        Titel: '',
        Beschreibung: ''
    });
    
    displayResultsInModal(currentContextData);
});

// Enhance summary button
document.getElementById('enhanceSummaryBtn')?.addEventListener('click', function() {
    if (!currentContextData) return;
    
    const btn = this;
    setLoading(btn, true);
    
    fetch(`/api/milestones/context/${currentContextData.id}/enhance-summary`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('modalSummaryText').value = data.enhanced_summary;
            currentContextData.summary = data.enhanced_summary;
            showToast('Summary enhanced successfully!', 'success');
        } else {
            showToast('Error enhancing summary: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error enhancing summary: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
});

// Accept optimized summary
document.getElementById('acceptOptimizedBtn')?.addEventListener('click', function() {
    if (!currentOptimizedSummary) {
        showToast('No optimized summary to save', 'warning');
        return;
    }
    
    const btn = this;
    setLoading(btn, true);
    
    fetch(`/api/milestones/${milestoneId}/save-optimized-summary`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            optimized_summary: currentOptimizedSummary,
            agent_name: currentOptimizationMeta?.agent_name || 'summary-enhancer-agent',
            model_name: currentOptimizationMeta?.model || 'gpt-4'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Optimized summary saved successfully!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('summaryOptimizationModal'));
            modal.hide();
            
            // Reload page to show new summary
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(data.error || 'Failed to save summary');
        }
    })
    .catch(error => {
        showToast('Error saving summary: ' + error.message, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
});

// Accept results button
document.getElementById('acceptResultsBtn')?.addEventListener('click', function() {
    if (!currentContextData) return;
    
    const btn = this;
    setLoading(btn, true);
    
    // Get edited values from modal
    const editedSummary = document.getElementById('modalSummaryText').value;
    
    // Collect edited tasks
    const editedTasks = [];
    const tasksList = document.getElementById('modalTasksList');
    tasksList.querySelectorAll('.list-group-item').forEach((item) => {
        const titleInput = item.querySelector('.task-title-input');
        const descInput = item.querySelector('.task-desc-input');
        
        if (titleInput && descInput) {
            const title = titleInput.value.trim();
            const desc = descInput.value.trim();
            
            if (title) {
                editedTasks.push({
                    Titel: title,
                    Beschreibung: desc
                });
            }
        }
    });
    
    // Send accept request
    fetch(`/api/milestones/context/${currentContextData.id}/accept-results`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            summary: editedSummary,
            derived_tasks: editedTasks
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Results accepted and applied!', 'success');
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('resultsModal'));
            if (modal) {
                modal.hide();
            }
            
            // Reload page after short delay
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error accepting results: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error accepting results: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
});

// Accept results button on context card
document.querySelectorAll('.accept-results-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const contextId = this.dataset.contextId;
        acceptResultsDirectly(contextId, this);
    });
});

function acceptResultsDirectly(contextId, btn) {
    if (!confirm('Accept the current analysis results and apply them to the milestone?')) {
        return;
    }
    
    setLoading(btn, true);
    
    fetch(`/api/milestones/context/${contextId}/accept-results`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Results accepted and applied!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showToast('Error accepting results: ' + error, 'error');
    })
    .finally(() => {
        setLoading(btn, false);
    });
}

// Helper function to show loading state
function setLoading(btn, loading) {
    if (!btn) return;
    
    if (loading) {
        btn.disabled = true;
        btn.classList.add('loading');
    } else {
        btn.disabled = false;
        btn.classList.remove('loading');
    }
}

// Initialize semantic network viewer when tab is shown
let milestoneSemanticNetworkViewer = null;

document.getElementById('semantic-network-tab')?.addEventListener('shown.bs.tab', function() {
    if (!milestoneSemanticNetworkViewer) {
        // Initialize the semantic network viewer on first show
        milestoneSemanticNetworkViewer = new SemanticNetworkViewer('milestoneSemanticNetworkContainer', {
            objectType: 'milestone',
            objectId: '{{ milestone.id }}',
            depth: 3,
            generateSummaries: true,
            includeHierarchy: false,
            onNodeClick: function(node) {
                // Handle node click - navigate to the object
                if (node.type === 'item') {
                    window.location.href = `/items/${node.id}/`;
                } else if (node.type === 'task') {
                    window.location.href = `/tasks/${node.id}/`;
                } else if (node.type === 'milestone') {
                    window.location.href = `/milestones/${node.id}/`;
                }
            }
        });
        
        // Load the semantic network
        milestoneSemanticNetworkViewer.load('milestone', '{{ milestone.id }}');
    }
});

// Initialize ToastUI Viewer for changelog markdown
{% if milestone.changelog %}
document.addEventListener('DOMContentLoaded', function() {
    const changelogMarkdownElement = document.querySelector('#changelogMarkdown');
    if (changelogMarkdownElement) {
        const viewer = new toastui.Editor.Viewer({
            el: document.querySelector('#changelogViewer'),
            initialValue: changelogMarkdownElement.value
        });
    }
});
{% endif %}
</script>
{% endblock %}
