{% if tasks %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead>
            <tr>
                <th style="width: 3%;">
                    <input type="checkbox" 
                           id="selectAllCheckbox" 
                           class="form-check-input" 
                           onchange="toggleSelectAll(this)">
                </th>
                <th style="width: 20%;">Title</th>
                <th style="width: 10%;">Type</th>
                <th style="width: 10%;">Status</th>
                <th style="width: 10%;">Requester</th>
                <th style="width: 15%;">Item</th>
                <th style="width: 10%;">GitHub Issue</th>
                <th style="width: 8%;">Updated</th>
                <th style="width: 14%;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr class="task-row">
                <td>
                    <input type="checkbox" 
                           class="form-check-input task-checkbox" 
                           data-task-id="{{ task.id }}"
                           onchange="updateSelectedCount()">
                </td>
                <td>
                    <a href="{% url 'main:task_detail' task.id %}" class="text-decoration-none fw-bold">
                        {{ task.title }}
                    </a>
                    {% if task.ai_enhanced %}
                    <span class="badge bg-info" title="AI Enhanced">
                        <i class="bi bi-stars"></i>
                    </span>
                    {% endif %}
                    {% if task.tags.all %}
                    <div class="mt-1">
                        {% for tag in task.tags.all %}
                        <span class="badge" style="background-color: {{ tag.color }}; font-size: 0.75rem;">
                            {{ tag.name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </td>
                <td>
                    <select class="form-select form-select-sm task-type-select" 
                            data-task-id="{{ task.id }}" 
                            style="width: auto; min-width: 100px;"
                            onchange="updateTaskType('{{ task.id }}', this.value)">
                        <option value="bug" {% if task.type == 'bug' %}selected{% endif %}>🐛 Bug</option>
                        <option value="feature" {% if task.type == 'feature' %}selected{% endif %}>✨ Feature</option>
                        <option value="frage" {% if task.type == 'frage' %}selected{% endif %}>❓ Frage</option>
                        <option value="support" {% if task.type == 'support' %}selected{% endif %}>🆘 Support</option>
                        <option value="idee" {% if task.type == 'idee' %}selected{% endif %}>💡 Idee</option>
                        <option value="sonstige" {% if task.type == 'sonstige' %}selected{% endif %}>📋 Sonstige</option>
                    </select>
                </td>
                <td>
                    {% if task.status == 'ready' %}
                    <span class="badge bg-success">🟢 Ready</span>
                    {% elif task.status == 'review' %}
                    <span class="badge bg-warning text-dark">🟡 Review</span>
                    {% elif task.status == 'working' %}
                    <span class="badge bg-primary">🔵 Working</span>
                    {% elif task.status == 'test' %}
                    <span class="badge bg-info">🧪 Test</span>
                    {% elif task.status == 'done' %}
                    <span class="badge bg-secondary">✅ Done</span>
                    {% else %}
                    <span class="badge bg-secondary">⚪ New</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.requester %}
                    <i class="bi bi-person"></i> {{ task.requester.username }}
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.item %}
                    <a href="{% url 'main:item_detail' task.item.id %}" class="text-decoration-none">
                        <i class="bi bi-lightbulb"></i> {{ task.item.title|truncatechars:30 }}
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if task.github_issue_id %}
                    <a href="{{ task.github_issue_url }}" target="_blank" class="text-decoration-none">
                        <i class="bi bi-github"></i> #{{ task.github_issue_id }}
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>
                    <small class="text-muted">
                        {{ task.updated_at|date:"Y-m-d" }}
                    </small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <a href="{% url 'main:task_detail' task.id %}" 
                           class="btn btn-sm btn-outline-primary" 
                           title="View Details"
                           data-bs-toggle="tooltip">
                            <i class="bi bi-eye"></i>
                        </a>
                        <a href="{% url 'main:task_edit' task.id %}" 
                           class="btn btn-sm btn-outline-secondary" 
                           title="Edit"
                           data-bs-toggle="tooltip">
                            <i class="bi bi-pencil"></i>
                        </a>
                        <button type="button" 
                                class="btn btn-sm btn-outline-info" 
                                title="AI Enhance"
                                data-bs-toggle="tooltip"
                                onclick="aiEnhanceTask('{{ task.id }}')">
                            <i class="bi bi-stars"></i>
                        </button>
                        {% if task.status != 'done' %}
                        <button type="button" 
                                class="btn btn-sm btn-outline-success" 
                                title="Mark as Done"
                                data-bs-toggle="tooltip"
                                onclick="markTaskAsDone('{{ task.id }}')">
                            <i class="bi bi-check-circle"></i>
                        </button>
                        {% endif %}
                        {% if not task.github_issue_id and task.status == 'ready' %}
                        <button type="button" 
                                class="btn btn-sm btn-outline-success" 
                                title="Create GitHub Issue"
                                data-bs-toggle="tooltip"
                                onclick="createGitHubIssue('{{ task.id }}')">
                            <i class="bi bi-github"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if tasks.has_other_pages %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if tasks.has_previous %}
        <li class="page-item">
            <a class="page-link" 
               href="?page=1&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-get="?page=1&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-target="#task-table-container"
               hx-swap="innerHTML"
               hx-indicator="#loading-indicator">
                <i class="bi bi-chevron-double-left"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" 
               href="?page={{ tasks.previous_page_number }}&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-get="?page={{ tasks.previous_page_number }}&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-target="#task-table-container"
               hx-swap="innerHTML"
               hx-indicator="#loading-indicator">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        {% endif %}
        
        <li class="page-item active">
            <span class="page-link">
                Page {{ tasks.number }} of {{ tasks.paginator.num_pages }}
            </span>
        </li>
        
        {% if tasks.has_next %}
        <li class="page-item">
            <a class="page-link" 
               href="?page={{ tasks.next_page_number }}&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-get="?page={{ tasks.next_page_number }}&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-target="#task-table-container"
               hx-swap="innerHTML"
               hx-indicator="#loading-indicator">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        <li class="page-item">
            <a class="page-link" 
               href="?page={{ tasks.paginator.num_pages }}&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-get="?page={{ tasks.paginator.num_pages }}&status={{ status_filter }}&item={{ item_filter }}&has_github={{ has_github }}&search={{ search_query }}"
               hx-target="#task-table-container"
               hx-swap="innerHTML"
               hx-indicator="#loading-indicator">
                <i class="bi bi-chevron-double-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center text-muted py-5">
    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
    <p class="mt-3">No tasks found.</p>
    {% if status_filter or item_filter or has_github or search_query %}
    <p>Try adjusting your filters.</p>
    <a href="{% url 'main:task_overview' %}" class="btn btn-outline-primary mt-2">
        <i class="bi bi-arrow-counterclockwise"></i> Clear Filters
    </a>
    {% else %}
    <p>Create your first task from an item!</p>
    <a href="{% url 'main:item_list' %}" class="btn btn-primary mt-2">
        <i class="bi bi-lightbulb"></i> Go to Items
    </a>
    {% endif %}
</div>
{% endif %}

<script>
// Re-initialize tooltips after HTMX swap
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'task-table-container') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
